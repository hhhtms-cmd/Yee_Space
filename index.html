<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yee Space - Auto Discovery</title>
    <style>
        body { margin: 0; background: #000; color: #00ffaa; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; text-align: center; }
        #display { width: 85%; font-size: 18px; min-height: 120px; line-height: 1.6; }
        #mic-btn { width: 80px; height: 80px; border-radius: 50%; border: 1px solid #00ffaa; font-size: 30px; display: none; align-items: center; justify-content: center; cursor: pointer; margin-top: 40px; }
        #mic-btn.active { box-shadow: 0 0 30px #00ffaa; background: rgba(0,255,170,0.2); }
        #log { position: fixed; bottom: 10px; font-size: 10px; color: #333; width: 90%; word-break: break-all; }
        .reset { position: fixed; top: 10px; right: 10px; cursor: pointer; opacity: 0.5; font-size: 12px; }
    </style>
</head>
<body>

    <div class="reset" onclick="localStorage.clear();location.reload();">[ é‡ç½®é…ç½® ]</div>

    <div id="display">æ­£åœ¨æ‰«æå¯ç”¨æ³¢æ®µ...</div>
    <div id="mic-btn">ğŸ™ï¸</div>
    <div id="log">æ­£åœ¨æ¢æµ‹ API æƒé™...</div>

    <script>
        // ä½¿ç”¨ç‹¬ç«‹å­˜å‚¨åï¼Œç¡®ä¿é‡æ–°è¾“å…¥
        let API_KEY = localStorage.getItem('yee_final_discovery');
        let VALID_MODEL_PATH = ""; 

        if (!API_KEY) {
            API_KEY = prompt("ç”±äºä¹‹å‰çš„ 404 é”™è¯¯ï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°æ¢æµ‹æ‚¨çš„ Key æƒé™ã€‚è¯·è¾“å…¥ API Keyï¼š");
            if (API_KEY) {
                localStorage.setItem('yee_final_discovery', API_KEY);
                location.reload();
            }
        }

        const display = document.getElementById('display');
        const micBtn = document.getElementById('mic-btn');
        const log = document.getElementById('log');

        // --- æ ¸å¿ƒé€»è¾‘ï¼šè‡ªåŠ¨è·å–ä½ èƒ½ç”¨çš„æ¨¡å‹åå• ---
        async function discoverModel() {
            try {
                // è¯·æ±‚æ¨¡å‹æ¸…å•
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${API_KEY}`);
                const data = await res.json();

                if (!res.ok) throw new Error(data.error?.message || "è¿æ¥å¤±è´¥");

                // ç­›é€‰å‡ºæ‰€æœ‰æ”¯æŒ å¯¹è¯ (generateContent) çš„æ¨¡å‹
                const availableModels = data.models.filter(m => 
                    m.supportedGenerationMethods.includes("generateContent")
                );

                if (availableModels.length > 0) {
                    // è‡ªåŠ¨é€‰æ‹©ä¸€ä¸ªæœ€å¥½çš„æ¨¡å‹ (ä¼˜å…ˆ 1.5 flash)
                    let best = availableModels.find(m => m.name.includes("1.5-flash")) || 
                               availableModels.find(m => m.name.includes("pro")) || 
                               availableModels[0];

                    // è¿™é‡Œæ‹¿åˆ°çš„ name å·²ç»æ˜¯å®Œæ•´è·¯å¾„ï¼Œå¦‚ "models/gemini-1.5-flash-latest"
                    VALID_MODEL_PATH = best.name; 
                    
                    display.innerText = "æ˜Ÿé™…è¿çº¿æˆåŠŸï¼\nå½“å‰é¢‘ç‡ï¼š" + best.displayName;
                    micBtn.style.display = "flex";
                    log.innerText = "è‡ªåŠ¨é€‰æ‹©è·¯å¾„: " + VALID_MODEL_PATH;
                } else {
                    display.innerText = "æ­¤ Key æ²¡æœ‰ä»»ä½•å¯ç”¨æ¨¡å‹ï¼Œè¯·åœ¨ Google AI Studio ç¡®è®¤ã€‚";
                }
            } catch (e) {
                display.innerText = "âŒ æ¢æµ‹å¤±è´¥";
                log.innerText = "è¯¦ç»†æŠ¥é”™: " + e.message;
            }
        }

        async function chat(text) {
            display.innerText = "ğŸŒŒ ä¿¡å·åŒæ­¥ä¸­...";
            try {
                // æ³¨æ„ï¼šè¿™é‡ŒåŠ¨æ€æ‹¼æ¥ä¾¦æµ‹åˆ°çš„è·¯å¾„
                const url = `https://generativelanguage.googleapis.com/v1beta/${VALID_MODEL_PATH}:generateContent?key=${API_KEY}`;
                
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: text }] }] })
                });

                const data = await res.json();
                
                if (data.candidates && data.candidates[0].content) {
                    display.innerText = data.candidates[0].content.parts[0].text;
                } else {
                    throw new Error(JSON.stringify(data));
                }
            } catch (e) {
                display.innerText = "âš ï¸ ä¼ è¾“é”™è¯¯";
                log.innerText = "åŸå› : " + e.message;
            }
        }

        // å¯åŠ¨æ¢æµ‹
        if (API_KEY) discoverModel();

        // è¯­éŸ³
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (Speech) {
            const rec = new Speech();
            rec.lang = 'zh-CN';
            micBtn.onclick = () => { rec.start(); display.innerText = "æ­£åœ¨å€¾å¬..."; micBtn.classList.add('active'); };
            rec.onresult = (e) => chat(e.results[0][0].transcript);
            rec.onend = () => micBtn.classList.remove('active');
        }
    </script>
</body>
</html>
