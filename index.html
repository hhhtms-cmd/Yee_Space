<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yee Space - Auto Discovery</title>
    <style>
        body { margin: 0; background: #000; color: #00ffaa; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; text-align: center; }
        #display { width: 85%; font-size: 18px; min-height: 120px; line-height: 1.6; }
        #mic-btn { width: 80px; height: 80px; border-radius: 50%; border: 1px solid #00ffaa; font-size: 30px; display: none; align-items: center; justify-content: center; cursor: pointer; margin-top: 40px; }
        #mic-btn.active { box-shadow: 0 0 30px #00ffaa; background: rgba(0,255,170,0.2); }
        #log { position: fixed; bottom: 10px; font-size: 10px; color: #444; width: 90%; word-break: break-all; }
        .reset { position: fixed; top: 10px; right: 10px; cursor: pointer; opacity: 0.3; font-size: 12px; }
    </style>
</head>
<body>

    <div class="reset" onclick="localStorage.clear();location.reload();">[ é‡ç½®æ‰€æœ‰è®¾ç½® ]</div>

    <div id="display">æ­£åœ¨æ‰«æå¯ç”¨æ³¢æ®µ...</div>
    <div id="mic-btn">ğŸ™ï¸</div>
    <div id="log"></div>

    <script>
        let API_KEY = localStorage.getItem('yee_auto_key');
        let VALID_MODEL = ""; // è‡ªåŠ¨è·å–çš„æ¨¡å‹è·¯å¾„

        if (!API_KEY) {
            API_KEY = prompt("è¯·å¡«å…¥ API Key å¼€å§‹å…¨è‡ªåŠ¨ä¾¦æµ‹ï¼š");
            if (API_KEY) { localStorage.setItem('yee_auto_key', API_KEY); location.reload(); }
        }

        const display = document.getElementById('display');
        const micBtn = document.getElementById('mic-btn');
        const log = document.getElementById('log');

        // ç¬¬ä¸€æ­¥ï¼šè‡ªåŠ¨ä¾¦æµ‹æ¨¡å‹åå•
        async function discoverModel() {
            try {
                log.innerText = "æ­£åœ¨è·å–æ¨¡å‹æ¸…å•...";
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${API_KEY}`);
                const data = await res.json();

                if (!res.ok) throw new Error(data.error?.message || "æ— æ³•è¿æ¥åˆ—è¡¨");

                // å¯»æ‰¾æ”¯æŒç”Ÿæˆå†…å®¹çš„æœ€å…ˆè¿›æ¨¡å‹
                const flash = data.models.find(m => m.name.includes('flash') && m.supportedGenerationMethods.includes('generateContent'));
                const pro = data.models.find(m => m.name.includes('pro') && m.supportedGenerationMethods.includes('generateContent'));
                const any = data.models.find(m => m.supportedGenerationMethods.includes('generateContent'));

                const target = flash || pro || any;

                if (target) {
                    VALID_MODEL = target.name; // å¾—åˆ°ç±»ä¼¼ "models/gemini-1.5-flash-latest"
                    display.innerText = "è¿æ¥æˆåŠŸï¼\nå½“å‰æ³¢æ®µï¼š" + target.displayName;
                    micBtn.style.display = "flex";
                    log.innerText = "ä½¿ç”¨è·¯å¾„: " + VALID_MODEL;
                } else {
                    display.innerText = "æŠ±æ­‰ï¼Œä½ çš„ Key æ²¡æœ‰ä»»ä½•å¯ç”¨æ¨¡å‹æƒé™ã€‚";
                }
            } catch (e) {
                display.innerText = "âŒ ä¾¦æµ‹å¤±è´¥";
                log.innerText = "é”™è¯¯è¯¦æƒ…: " + e.message;
            }
        }

        // ç¬¬äºŒæ­¥ï¼šæ‰§è¡Œå¯¹è¯
        async function chat(text) {
            display.innerText = "ğŸŒŒ ä¼ è¾“ä¸­...";
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/${VALID_MODEL}:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: text }] }] })
                });
                const data = await res.json();
                display.innerText = data.candidates[0].content.parts[0].text;
            } catch (e) {
                display.innerText = "âš ï¸ ä¼ è¾“é”™è¯¯";
                log.innerText = e.message;
            }
        }

        // è¯­éŸ³é€»è¾‘
        if (API_KEY) discoverModel();

        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (Speech) {
            const rec = new Speech();
            rec.lang = 'zh-CN';
            micBtn.onclick = () => { rec.start(); display.innerText = "è¯·è¯´è¯..."; micBtn.classList.add('active'); };
            rec.onresult = (e) => chat(e.results[0][0].transcript);
            rec.onend = () => micBtn.classList.remove('active');
        }
    </script>
</body>
</html>
