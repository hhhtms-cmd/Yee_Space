<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yee's Space (Auto-Detect)</title>
    <style>
        :root { --main: #00ffaa; --bg: #050505; }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; overflow: hidden; }

        /* ç™»å½•å±‚ */
        #login-box { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .box-content { background: #111; padding: 40px; border-radius: 20px; border: 1px solid #333; text-align: center; width: 300px; }
        #key-input { width: 100%; padding: 12px; margin: 20px 0; background: #222; border: 1px solid #555; color: var(--main); text-align: center; border-radius: 5px; outline: none; }
        .btn-enter { background: var(--main); color: black; border: none; padding: 10px 30px; border-radius: 20px; font-weight: bold; cursor: pointer; }

        /* ä¸»ç•Œé¢ */
        #top-bar { position: absolute; top: 15px; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box; z-index: 100; }
        .action-btn { background: rgba(255,255,255,0.1); border: 1px solid #444; color: white; padding: 6px 16px; border-radius: 20px; cursor: pointer; font-size: 12px; display: inline-block; }
        .reset-btn { border-color: #ff5555; color: #ffaaaa; }
        
        #chat-container { position: absolute; top: 160px; width: 100%; text-align: center; z-index: 10; padding: 0 20px; box-sizing: border-box; }
        #ai-msg { font-size: 19px; line-height: 1.6; min-height: 40px; text-shadow: 0 0 10px rgba(0,0,0,0.8); }
        #user-msg { font-size: 14px; opacity: 0.5; margin-top: 15px; font-style: italic; }
        #model-tag { font-size: 10px; color: #555; margin-top: 5px; border: 1px solid #333; padding: 2px 8px; border-radius: 10px; display: inline-block; }

        #bottom-ctrl { position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%); text-align: center; z-index: 100; display: flex; flex-direction: column; align-items: center; }
        #mic-circle { width: 65px; height: 65px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; font-size: 28px; cursor: pointer; margin-bottom: 20px; transition: 0.3s; }
        #mic-circle.active { border-color: var(--main); box-shadow: 0 0 25px var(--main); background: rgba(0,255,170,0.1); transform: scale(1.1); }

        /* å¡ç‰‡å¼¹çª— */
        #card-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(10px); }
        .card-body { background: #1a1a1a; padding: 40px; border-radius: 20px; border: 1px solid #444; max-width: 320px; text-align: center; line-height: 1.8; }
    </style>
</head>
<body>

    <div id="login-box">
        <div class="box-content">
            <h2 style="margin:0; font-weight:200; letter-spacing: 2px;">YEE SPACE</h2>
            <p style="font-size:12px; color:#888;">è¯·è¾“å…¥æ‚¨çš„ Google API Key</p>
            <input type="password" id="key-input" placeholder="AIzaSy...">
            <button class="btn-enter" onclick="saveKey()">è¿›å…¥ç©ºé—´</button>
            <p style="font-size:10px; color:#555; margin-top:15px;">Key ä»…ä¿å­˜åœ¨æœ¬åœ°</p>
        </div>
    </div>

    <div id="top-bar">
        <label class="action-btn">ğŸ“¸ ä¸Šä¼ ç…§ç‰‡ç²’å­ <input type="file" id="file-in" hidden accept="image/*"></label>
        <button class="action-btn reset-btn" onclick="resetKey()">ğŸ”„ æ›´æ¢ API KEY</button>
    </div>

    <div id="chat-container">
        <div id="ai-msg">æ­£åœ¨è‡ªåŠ¨ä¾¦æµ‹æœ€ä½³æ¨¡å‹...</div>
        <div id="model-tag">æ£€æµ‹ä¸­...</div>
        <div id="user-msg"></div>
    </div>

    <div id="bottom-ctrl">
        <div id="mic-circle">ğŸ™ï¸</div>
        <button class="action-btn" id="gen-card">âœ¨ ç”Ÿæˆä»Šæ—¥æ„Ÿæ‚Ÿ</button>
    </div>

    <div id="card-modal" onclick="this.style.display='none'">
        <div class="card-body">
            <div id="card-text">æ­£åœ¨å‡ç»“è®°å¿†...</div>
        </div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- æ ¸å¿ƒå˜é‡ ---
        let API_KEY = localStorage.getItem('yee_auto_key'); 
        let CURRENT_MODEL = "gemini-1.5-flash"; // é»˜è®¤å¤‡ä»½
        let scene, camera, renderer, particles;
        let history = []; 

        // --- 1. å¯åŠ¨é€»è¾‘ ---
        if (API_KEY && API_KEY.startsWith("AIza")) {
            document.getElementById('login-box').style.display = 'none';
            initSpace();
        }

        window.saveKey = function() {
            const input = document.getElementById('key-input').value.trim();
            if (input.startsWith("AIza")) {
                localStorage.setItem('yee_auto_key', input);
                API_KEY = input;
                location.reload(); 
            } else {
                alert("Key æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ˜¯å¦å®Œæ•´å¤åˆ¶");
            }
        };

        window.resetKey = function() {
            if(confirm("ç¡®å®šè¦æ¸…é™¤ Key å¹¶é‡æ–°è¾“å…¥å—ï¼Ÿ")) {
                localStorage.removeItem('yee_auto_key');
                location.reload();
            }
        };

        // --- 2. è‡ªåŠ¨ä¾¦æµ‹æ¨¡å‹ (å…³é”®ä¿®å¤) ---
        async function autoDetectModel() {
            try {
                // è¯·æ±‚ Google åˆ—å‡ºæ‰€æœ‰å¯ç”¨æ¨¡å‹
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${API_KEY}`);
                const data = await res.json();
                
                if(data.models) {
                    // å¯»æ‰¾åŒ…å« 'generateContent' åŠŸèƒ½çš„ Gemini æ¨¡å‹
                    const validModels = data.models.filter(m => 
                        m.name.includes("gemini") && 
                        m.supportedGenerationMethods.includes("generateContent")
                    );

                    if(validModels.length > 0) {
                        // ä¼˜å…ˆæ‰¾ flashï¼Œæ²¡æœ‰å°±æ‰¾ proï¼Œå†æ²¡æœ‰å°±ç”¨ç¬¬ä¸€ä¸ª
                        let best = validModels.find(m => m.name.includes("1.5-flash"));
                        if(!best) best = validModels.find(m => m.name.includes("1.5-pro"));
                        if(!best) best = validModels[0];
                        
                        // è¿™é‡Œçš„ name æ ¼å¼é€šå¸¸æ˜¯ "models/gemini-1.5-flash"
                        // æˆ‘ä»¬åªéœ€è¦åé¢é‚£éƒ¨åˆ†ï¼Œæˆ–è€…ç›´æ¥ç”¨å…¨å
                        CURRENT_MODEL = best.name.replace("models/", "");
                        document.getElementById('model-tag').innerText = "å·²è¿æ¥: " + CURRENT_MODEL;
                        document.getElementById('ai-msg').innerText = "æ¨¡å‹é€‚é…æˆåŠŸã€‚è¯·è¯´è¯æˆ–ä¸Šä¼ ç…§ç‰‡ã€‚";
                        return;
                    }
                }
                throw new Error("æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹");
            } catch(e) {
                console.error(e);
                // å¦‚æœä¾¦æµ‹å¤±è´¥ï¼Œå›é€€åˆ°æœ€æœ€åŸºç¡€çš„ 1.0 pro
                CURRENT_MODEL = "gemini-pro";
                document.getElementById('model-tag').innerText = "è¿æ¥: åŸºç¡€ç‰ˆ (Fallback)";
                document.getElementById('ai-msg').innerText = "è‡ªåŠ¨ä¾¦æµ‹å¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€æ¨¡å‹ã€‚è¯·å°è¯•å¯¹è¯ã€‚";
            }
        }

        // --- 3. 3D åœºæ™¯ ---
        async function initSpace() {
            // å…ˆåˆå§‹åŒ– 3Dï¼Œå†ä¾¦æµ‹æ¨¡å‹
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            camera.position.z = 15;

            createParticles(); 
            animate();
            
            // æ‰§è¡Œæ¨¡å‹ä¾¦æµ‹
            await autoDetectModel();
        }

        function createParticles(positions = null, colors = null) {
            if (particles) scene.remove(particles);
            const geo = new THREE.BufferGeometry();
            
            if (positions) {
                geo.setAttribute('position
