<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YEE SPACE - ULTIMATE</title>
    <style>
        body { margin: 0; background: #000; color: #00ffaa; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; text-align: center; }
        #display { width: 85%; font-size: 19px; min-height: 120px; line-height: 1.6; text-shadow: 0 0 10px rgba(0,255,170,0.5); }
        #mic-btn { width: 85px; height: 85px; border-radius: 50%; border: 1px solid #00ffaa; font-size: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; margin-top: 40px; }
        #mic-btn.active { box-shadow: 0 0 30px #00ffaa; background: rgba(0,255,170,0.2); transform: scale(1.1); }
        #debug-log { position: fixed; bottom: 15px; font-size: 10px; color: #333; width: 90%; word-break: break-all; }
        .reset-btn { position: fixed; top: 15px; right: 15px; cursor: pointer; opacity: 0.4; font-size: 11px; border: 1px solid #333; padding: 4px 8px; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="reset-btn" onclick="localStorage.clear();location.reload();">é‡ç½®è¿æ¥</div>

    <div id="display">æ­£åœ¨åˆå§‹åŒ–ç¨³å®šç‰ˆæ³¢æ®µ...</div>
    <div id="mic-btn">ğŸ™ï¸</div>
    <div id="debug-log">Ready.</div>

    <script>
        // 1. å¼ºåˆ¶ä½¿ç”¨æ–°å­˜å‚¨åï¼Œç¡®ä¿é‡æ–°è¾“å…¥
        let API_KEY = localStorage.getItem('yee_ultimate_key');

        if (!API_KEY) {
            API_KEY = prompt("ä¸ºäº†ä¿®å¤ 404 é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥æ‚¨çš„ API Keyï¼š");
            if (API_KEY) {
                localStorage.setItem('yee_ultimate_key', API_KEY);
                location.reload();
            }
        }

        const display = document.getElementById('display');
        const micBtn = document.getElementById('mic-btn');
        const debug = document.getElementById('debug-log');

        if(API_KEY) display.innerText = "æ˜Ÿé™…é€šé“å·²åŠ å›ºã€‚è¯·æŒ‰ä½éº¦å…‹é£å¼€å§‹äº¤è°ˆã€‚";

        // 2. æ ¸å¿ƒè¯·æ±‚å‡½æ•° (é‡‡ç”¨æœ€ç¨³å¦¥çš„ v1 è·¯å¾„)
        async function talkToAI(text) {
            display.innerText = "ğŸŒŒ æ­£åœ¨åŒæ­¥ä¿¡å·...";
            debug.innerText = "å‘é€è¯·æ±‚è‡³: gemini-1.5-flash-8b";

            try {
                // æ–¹æ¡ˆï¼šä½¿ç”¨ v1 ç¨³å®šç‰ˆè·¯å¾„ + flash-8b (è¿™æ˜¯ç›®å‰å…è´¹é¢åº¦æœ€ç¨³çš„æ¨¡å‹å)
                const url = `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash-8b:generateContent?key=${API_KEY}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: text }] }]
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    // å¦‚æœè¿˜æ˜¯ 404ï¼Œå°è¯•å…œåº•åˆ° gemini-1.5-flash (ä¸å¸¦ 8b)
                    if (response.status === 404) {
                        return tryFallback(text);
                    }
                    throw new Error(data.error?.message || "æœªçŸ¥é”™è¯¯");
                }

                display.innerText = data.candidates[0].content.parts[0].text;
                debug.innerText = "å“åº”æˆåŠŸ";

            } catch (err) {
                display.innerText = "âš ï¸ é€šé“å—å¹²æ‰°";
                debug.innerText = "å¤±è´¥è¯¦æƒ…: " + err.message;
            }
        }

        // 3. å…œåº•é€»è¾‘
        async function tryFallback(text) {
            debug.innerText = "å°è¯•å¤‡ç”¨æ³¢æ®µ (gemini-1.5-flash)...";
            const url = `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: text }] }] })
                });
                const data = await response.json();
                display.innerText = data.candidates[0].content.parts[0].text;
            } catch (e) {
                display.innerText = "âŒ ä¸¤ä¸ªé¢‘é“å‡æ— æ³•è®¿é—®";
                debug.innerText = "æœ€ç»ˆé”™è¯¯: " + e.message;
            }
        }

        // 4. è¯­éŸ³è¯†åˆ«é€»è¾‘
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (Speech) {
            const rec = new Speech();
            rec.lang = 'zh-CN';

            micBtn.onclick = () => {
                try {
                    rec.start();
                    micBtn.classList.add('active');
                    display.innerText = "æ­£åœ¨å€¾å¬...";
                } catch(e) { console.error(e); }
            };

            rec.onresult = (e) => {
                const transcript = e.results[0][0].transcript;
                talkToAI(transcript);
            };

            rec.onend = () => {
                micBtn.classList.remove('active');
            };
        } else {
            display.innerText = "å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³ï¼Œè¯·å°è¯• Chromeã€‚";
        }
    </script>
</body>
</html>
