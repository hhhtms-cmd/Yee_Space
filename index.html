<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yee Space - Fixed</title>
    <style>
        body { margin: 0; background: #000; color: #00ffaa; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        #display { width: 85%; text-align: center; font-size: 20px; min-height: 100px; line-height: 1.6; }
        #mic-btn { width: 80px; height: 80px; border-radius: 50%; border: 1px solid #00ffaa; font-size: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; margin-top: 40px; }
        #mic-btn.active { box-shadow: 0 0 30px #00ffaa; background: rgba(0,255,170,0.2); }
        #err-log { position: fixed; bottom: 20px; color: #ff4444; font-size: 12px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 8px; display: none; width: 80%; text-align: center; }
        .reset-link { position: fixed; top: 10px; right: 10px; color: #333; cursor: pointer; font-size: 12px; }
    </style>
</head>
<body>

    <div class="reset-link" onclick="resetKey()">[ é‡ç½® API KEY ]</div>

    <div id="display">æ­£åœ¨åˆå§‹åŒ–æ˜Ÿé™…é“¾æ¥...</div>
    <div id="mic-btn">ğŸ™ï¸</div>
    <div id="err-log"></div>

    <script>
        // ä½¿ç”¨æ–°å­˜å‚¨åç§°ï¼Œå¼ºåˆ¶åˆ·æ–°ä¸€æ¬¡ Key çš„è¯»å–
        let API_KEY = localStorage.getItem('yee_fixed_v4');

        if (!API_KEY) {
            API_KEY = prompt("404 é”™è¯¯å·²æ•è·ï¼Œè¯·é‡æ–°è¾“å…¥ API Key æ¿€æ´»ç¨³å®šç‰ˆè·¯å¾„ï¼š");
            if (API_KEY) {
                localStorage.setItem('yee_fixed_v4', API_KEY);
                location.reload();
            }
        }

        const display = document.getElementById('display');
        const errLog = document.getElementById('err-log');
        if(API_KEY) display.innerText = "æ˜Ÿé™…è¿çº¿å·²å°±ç»ªã€‚è¯·æŒ‰ä½éº¦å…‹é£è¯´è¯ã€‚";

        function resetKey() {
            localStorage.removeItem('yee_fixed_v4');
            location.reload();
        }

        async function chat(text) {
            display.innerText = "ğŸŒŒ ä¿¡å·ä¼ è¾“ä¸­...";
            errLog.style.display = "none";

            // ä¿®æ­£åçš„å…³é”® URLï¼šä½¿ç”¨ v1beta å’Œ models/ å‰ç¼€
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: text }] }]
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error?.message || "è¯·æ±‚å¤±è´¥");
                }

                if (data.candidates && data.candidates[0].content) {
                    display.innerText = data.candidates[0].content.parts[0].text;
                }
            } catch (err) {
                console.error(err);
                display.innerText = "âš ï¸ è¿çº¿ä¸­æ–­";
                errLog.style.display = "block";
                errLog.innerText = "è¯Šæ–­ä¿¡æ¯: " + err.message;
            }
        }

        // è¯­éŸ³é€»è¾‘
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (Speech) {
            const rec = new Speech();
            rec.lang = 'zh-CN';
            const btn = document.getElementById('mic-btn');

            btn.onclick = () => {
                try {
                    rec.start();
                    btn.classList.add('active');
                    display.innerText = "æ­£åœ¨å€¾å¬...";
                } catch(e) {}
            };

            rec.onresult = (e) => {
                const result = e.results[0][0].transcript;
                chat(result);
            };

            rec.onend = () => btn.classList.remove('active');
        } else {
            display.innerText = "å½“å‰æµè§ˆå™¨æš‚ä¸æ”¯æŒè¯­éŸ³åŠŸèƒ½";
        }
    </script>
</body>
</html>
