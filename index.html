<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yeeçš„æ—¥è®°ç©ºé—´ - æœ€ç»ˆç‰ˆ</title>
    <style>
        :root { --accent-color: #00ffaa; --bg-color: #050505; }
        body { margin: 0; background: var(--bg-color); overflow: hidden; color: white; font-family: "PingFang SC", "Helvetica Neue", sans-serif; }
        
        /* é¡¶éƒ¨å¯¼èˆª */
        nav { position: absolute; top: 0; width: 100%; padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; z-index: 10; opacity: 0.8; font-size: 12px; letter-spacing: 2px; }
        .nav-brand { font-weight: bold; font-size: 14px; text-shadow: 0 0 10px rgba(0,255,170,0.5); }
        .nav-links span { margin-left: 20px; cursor: pointer; opacity: 0.7; transition: 0.3s; }
        .nav-links span:hover { opacity: 1; color: var(--accent-color); }

        /* ç´§æ€¥ Key è®¾ç½®æŒ‰é’® */
        #key-setting { position: fixed; top: 20px; left: 20px; z-index: 9999; font-size: 10px; opacity: 0.3; cursor: pointer; border: 1px solid white; padding: 2px 8px; border-radius: 4px; }
        #key-setting:hover { opacity: 1; background: white; color: black; }

        /* çŠ¶æ€æ¡ */
        #status-bar { position: absolute; top: 80px; left: 50%; transform: translateX(-50%); display: flex; align-items: center; background: rgba(255,255,255,0.05); padding: 6px 16px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); z-index: 10; font-size: 12px; backdrop-filter: blur(5px); }
        .dot { width: 6px; height: 6px; background: var(--accent-color); border-radius: 50%; margin-right: 8px; box-shadow: 0 0 8px var(--accent-color); transition: 0.3s; }
        
        /* èŠå¤©åŒºåŸŸ */
        #chat-area { position: absolute; top: 180px; width: 100%; text-align: center; z-index: 20; padding: 0 20px; box-sizing: border-box; }
        #ai-reply { font-size: 18px; font-weight: 300; margin-bottom: 20px; min-height: 1.5em; text-shadow: 0 0 10px rgba(0,0,0,0.5); line-height: 1.6; max-width: 800px; margin-left: auto; margin-right: auto; }
        #user-speech { font-size: 14px; color: rgba(255,255,255,0.5); margin-bottom: 25px; font-style: italic; }
        
        /* è¾“å…¥æ¡† */
        #text-input { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1); border-radius: 25px; color: white; text-align: center; width: 260px; outline: none; font-size: 14px; padding: 10px 20px; transition: 0.3s; }
        #text-input:focus { border-color: var(--accent-color); background: rgba(0,0,0,0.5); width: 300px; }

        /* åº•éƒ¨æ§åˆ¶åŒº */
        #controls { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; z-index: 20; }
        #mic-btn { width: 60px; height: 60px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; margin-bottom: 20px; font-size: 24px; backdrop-filter: blur(5px); }
        #mic-btn:hover { background: rgba(255,255,255,0.15); border-color: var(--accent-color); transform: scale(1.05); }
        #mic-btn.active { border-color: #ff4444; box-shadow: 0 0 20px #ff4444; background: rgba(255,0,0,0.1); }
        
        #save-btn { padding: 10px 25px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.3); background: transparent; color: white; cursor: pointer; font-size: 11px; letter-spacing: 2px; transition: 0.3s; text-transform: uppercase; }
        #save-btn:hover { background: white; color: black; box-shadow: 0 0 15px white; }

        /* å¡ç‰‡å¼¹çª— */
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(15px); }
        .card { width: 320px; padding: 40px; background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); border: 1px solid rgba(255,255,255,0.1); border-radius: 30px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative; }
        .card-date { font-size: 10px; opacity: 0.5; margin-bottom: 30px; letter-spacing: 4px; color: var(--accent-color); }
        .card-content { font-size: 16px; line-height: 1.8; font-weight: 300; margin-bottom: 40px; color: #eee; }
        .card-tag { display: inline-block; padding: 5px 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); font-size: 10px; color: var(--accent-color); }
        .close-card { position: absolute; top: 20px; right: 20px; cursor: pointer; opacity: 0.5; font-size: 20px; }

        /* å¯åŠ¨é®ç½© */
        #start-mask { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.5s; }
        #start-mask h1 { font-weight: 200; letter-spacing: 5px; font-size: 24px; margin-bottom: 20px; }
        #start-mask p { font-size: 12px; opacity: 0.5; }
    </style>
</head>
<body>

    <div id="key-setting" onclick="updateKey()">ğŸ”‘ é‡ç½® KEY</div>

    <div id="start-mask">
        <h1>ENTER YEE'S SPACE</h1>
        <p>ç‚¹å‡»ä»»æ„å¤„å¼€å¯ / CLICK TO START</p>
    </div>

    <nav>
        <div class="nav-brand">YEE'S SPACE</div>
        <div class="nav-links">
            <span>MEMORY</span><span>MUSIC</span><span>INFO</span>
        </div>
    </nav>

    <div id="status-bar">
        <div class="dot" id="status-dot"></div> 
        <span id="status-text">System Ready</span>
    </div>

    <div id="chat-area">
        <div id="ai-reply">ä½ å¥½ï¼ŒYeeã€‚æˆ‘æ˜¯ä½ çš„ AI è®°å½•å‘˜ã€‚</div>
        <div id="user-speech">...</div>
        <input type="text" id="text-input" placeholder="è¯­éŸ³æ— æ³•ä½¿ç”¨æ—¶ï¼Œè¯·åœ¨æ­¤æ‰“å­—å¹¶å›è½¦">
    </div>

    <div id="controls">
        <div id="mic-btn">ğŸ™ï¸</div>
        <button id="save-btn">GENERATE MEMORY CARD</button>
    </div>

    <div id="overlay">
        <div class="card">
            <div class="close-card" onclick="document.getElementById('overlay').style.display='none'">Ã—</div>
            <div class="card-date" id="date-str">DATE</div>
            <div class="card-content" id="summary-text">æ­£åœ¨ç”Ÿæˆ...</div>
            <div class="card-tag" id="summary-tag">#</div>
        </div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- æ ¸å¿ƒé…ç½® ---
        // 1. ä¼˜å…ˆè¯»å–æœ¬åœ°å­˜å‚¨çš„ Keyï¼ˆé˜²æ­¢ç¡¬ç¼–ç å¤±æ•ˆï¼‰
        // 2. å¦‚æœæœ¬åœ°æ²¡æœ‰ï¼Œåˆ™ä½¿ç”¨ä½ æä¾›çš„ç¡¬ç¼–ç  Key
        let API_KEY = localStorage.getItem('gemini_key') || "AIzaSyDk8ZrNTwryMCp1IWIZ8ufwYqgiA00JHjw";
        
        // å¦‚æœä½ éœ€è¦æ›´æ¢ç…§ç‰‡ï¼Œè¯·ä¿®æ”¹è¿™é‡Œ
        const imageUrl = 'https://threejs.org/examples/textures/uv_grid_opengl.jpg'; 

        // å…¨å±€å˜é‡
        let analyser, dataArray, audioContext, particles, geometry;
        let isAudioReady = false;
        let conversationHistory = [];

        // --- å…¨å±€å‡½æ•°: æ›´æ–° Key ---
        window.updateKey = function() {
            const newKey = prompt("è¯·è¾“å…¥æ–°çš„ Gemini API Key:", API_KEY);
            if(newKey) {
                API_KEY = newKey;
                localStorage.setItem('gemini_key', newKey);
                alert("Key å·²æ›´æ–°ï¼Œè¯·åˆ·æ–°é¡µé¢ç”Ÿæ•ˆã€‚");
                location.reload();
            }
        };

        // --- 1. Three.js ç²’å­è§†è§‰ ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // åŠ è½½çº¹ç†
        const loader = new THREE.TextureLoader();
        loader.load(imageUrl, (texture) => {
            // é‡‡æ ·å›¾ç‰‡ç”Ÿæˆç²’å­
            const width = 160, height = 160;
            const canvas = document.createElement('canvas');
            canvas.width = width; canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(texture.image, 0, 0, width, height);
            const imgData = ctx.getImageData(0, 0, width, height).data;
            
            const pos = [], cols = [];
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const i = (y * width + x) * 4;
                    // åªä¿ç•™éé€æ˜åƒç´ 
                    if(imgData[i+3] > 100) { 
                        pos.push((x - width/2) * 0.08, -(y - height/2) * 0.08, 0);
                        cols.push(imgData[i]/255, imgData[i+1]/255, imgData[i+2]/255);
                    }
                }
            }
            
            geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(cols, 3));
            
            const material = new THREE.PointsMaterial({ 
                size: 0.04, 
                vertexColors: true, 
                transparent: true, 
                opacity: 0.8,
                blending: THREE.AdditiveBlending 
            });
            
            particles = new THREE.Points(geometry, material);
            scene.add(particles);
            camera.position.z = 10;
            animate();
        });

        // åŠ¨ç”»å¾ªç¯
        function animate() {
            requestAnimationFrame(animate);
            
            let vol = 0;
            if (isAudioReady && analyser) {
                analyser.getByteFrequencyData(dataArray);
                let sum = 0;
                for(let i=0; i<dataArray.length; i++) sum += dataArray[i];
                vol = sum / dataArray.length; // 0 ~ 255
            }

            if(geometry) {
                const posArr = geometry.attributes.position.array;
                const time = performance.now() * 0.001;
                
                // ç²’å­æ³¢åŠ¨é€»è¾‘
                for (let i = 0; i < posArr.length; i += 3) {
                    const x = posArr[i];
                    const y = posArr[i+1];
                    // åŸºç¡€å‘¼å¸ + å£°éŸ³éœ‡åŠ¨
                    // å£°éŸ³è¶Šå¤§ï¼ŒæŒ¯å¹…(amp)è¶Šå¤§
                    const amp = 0.2 + (vol / 255) * 0.5; 
                    posArr[i + 2] = Math.sin(time * 2 + x * 0.5) * amp;
                }
                geometry.attributes.position.needsUpdate = true;
            }
            
            // ç¼“æ…¢è‡ªè½¬
            if(particles) particles.rotation.y += 0.001;
            
            renderer.render(scene, camera);
        }

        // --- 2. å¯åŠ¨é€»è¾‘ (è§£å†³æµè§ˆå™¨éŸ³é¢‘ç­–ç•¥) ---
        document.getElementById('start-mask').onclick = async () => {
            const mask = document.getElementById('start-mask');
            mask.style.opacity = '0';
            setTimeout(() => mask.style.display = 'none', 500);
            
            // åˆå§‹åŒ–éŸ³é¢‘
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                source.connect(analyser);
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                isAudioReady = true;
                updateStatus("System Ready", "#00ffaa");
            } catch(e) {
                console.error(e);
                updateStatus("Mic Denied (Audio Only Visuals Disabled)", "orange");
            }
        };

        function updateStatus(text, color) {
            document.getElementById('status-text').innerText = text;
            document.getElementById('status-dot').style.backgroundColor = color;
            document.getElementById('status-dot').style.boxShadow = `0 0 10px ${color}`;
        }

        // --- 3. Gemini API é€šä¿¡ ---
        async function chatWithGemini(userText) {
            if(!userText) return;
            
            // 1. ä¸Šå±ç”¨æˆ·çš„å­—
            document.getElementById('user-speech').innerText = `â€œ ${userText} â€`;
            document.getElementById('ai-reply').innerText = "Thinking...";
            updateStatus("AI Processing...", "cyan");

            // 2. è®°å½•å†å²
            conversationHistory.push({ role: "user", parts: [{ text: userText }] });

            try {
                // 3. å‘é€è¯·æ±‚
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: conversationHistory })
                });

                const data = await response.json();

                if(!response.ok) {
                    throw new Error(data.error?.message || "API Connection Failed");
                }

                const reply = data.candidates[0].content.parts[0].text;
                
                // 4. AI å›å¤ä¸Šå±
                document.getElementById('ai-reply').innerText = reply;
                conversationHistory.push({ role: "model", parts: [{ text: reply }] });
                updateStatus("Gemini Active", "#00ffaa");

            } catch (err) {
                console.error(err);
                document.getElementById('ai-reply').innerText = `[Error] ${err.message}`;
                updateStatus("Connection Error", "red");
                
                // æç¤ºç”¨æˆ·å¯èƒ½æ˜¯ Key é—®é¢˜
                if(err.message.includes('API key not valid') || err.message.includes('403')) {
                    alert("ä½ çš„ API Key å¯èƒ½å¤±æ•ˆäº†ï¼ˆGitHub å…¬å¼€ Key å®¹æ˜“è¢«å°ï¼‰ã€‚\nè¯·ç‚¹å‡»å·¦ä¸Šè§’ 'é‡ç½® KEY' æŒ‰é’®ï¼Œå¡«å…¥ä¸€ä¸ªæ–°çš„ Keyã€‚");
                }
            }
        }

        // --- 4. è¾“å…¥äº¤äº’ (è¯­éŸ³ + é”®ç›˜) ---
        
        // A. é”®ç›˜å›è½¦
        document.getElementById('text-input').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') {
                chatWithGemini(e.target.value);
                e.target.value = '';
            }
        });

        // B. è¯­éŸ³è¯†åˆ« (Web Speech API)
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (Speech) {
            const recognition = new Speech();
            recognition.lang = 'zh-CN';
            recognition.interimResults = true;

            const micBtn = document.getElementById('mic-btn');

            micBtn.onclick = () => {
                try {
                    recognition.start();
                    micBtn.classList.add('active');
                    updateStatus("Listening...", "#ff4444");
                } catch(e) {
                    console.log("Speech recognition already started");
                }
            };

            recognition.onresult = (e) => {
                const text = Array.from(e.results)
                    .map(r => r[0])
                    .map(r => r.transcript).join('');
                
                document.getElementById('user-speech').innerText = text; // å®æ—¶æ˜¾ç¤º

                if (e.results[0].isFinal) {
                    micBtn.classList.remove('active');
                    chatWithGemini(text);
                }
            };

            recognition.onend = () => {
                micBtn.classList.remove('active');
                if(document.getElementById('status-text').innerText === "Listening...") {
                     updateStatus("Gemini Active", "#00ffaa");
                }
            };
            
            recognition.onerror = (e) => {
                console.error(e);
                micBtn.classList.remove('active');
                updateStatus("Speech Error: " + e.error, "orange");
            };
        } else {
            // æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³
            document.getElementById('mic-btn').style.display = 'none';
            document.getElementById('user-speech').innerText = "Current browser does not support voice. Please type below.";
        }

        // --- 5. ç”Ÿæˆæ—¥è®°å¡ç‰‡ ---
        document.getElementById('save-btn').onclick = async () => {
            const overlay = document.getElementById('overlay');
            overlay.style.display = 'flex';
            
            document.getElementById('date-str').innerText = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }).toUpperCase();
            document.getElementById('summary-text').innerText = "æ­£åœ¨æ„Ÿæ‚Ÿä½ çš„è®°å¿†...";

            if(conversationHistory.length === 0) {
                document.getElementById('summary-text').innerText = "è¿˜æ²¡æœ‰ç•™ä¸‹ä»»ä½•è®°å¿†ã€‚\nè¯·å…ˆå¯¹è¯ã€‚";
                return;
            }

            // å‘é€æ€»ç»“æŒ‡ä»¤
            try {
                const prompt = "è¯·æ ¹æ®æˆ‘ä»¬çš„å¯¹è¯ï¼Œå†™ä¸€æ®µ30å­—ä»¥å†…ã€å¯Œæœ‰è¯—æ„çš„æ—¥è®°æ€»ç»“ã€‚å¹¶åœ¨æœ€ååŠ ä¸€ä¸ª#å½¢å¼çš„å¿ƒæƒ…æ ‡ç­¾ï¼ˆä¾‹å¦‚ #å¹³é™ï¼‰ã€‚";
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        contents: [...conversationHistory, { role: "user", parts: [{ text: prompt }] }] 
                    })
                });

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                
                // è§£ææ ‡ç­¾
                const parts = text.split('#');
                document.getElementById('summary-text').innerText = parts[0].trim();
                if(parts.length > 1) {
                    document.getElementById('summary-tag').innerText = '#' + parts[parts.length-1].trim();
                } else {
                    document.getElementById('summary-tag').innerText = "# è®°å½•";
                }

            } catch(e) {
                document.getElementById('summary-text').innerText = "æ€»ç»“ç”Ÿæˆå¤±è´¥ã€‚\n" + e.message;
            }
        };

    </script>
</body>
</html>
