<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yee's Memory Space</title>
    <style>
        :root { --accent-color: #00ffaa; --bg-color: #050505; }
        body { margin: 0; background: var(--bg-color); overflow: hidden; color: white; font-family: "PingFang SC", "Helvetica Neue", sans-serif; }
        
        /* 1. Ê¨¢Ëøé/Key ËæìÂÖ•ÁïåÈù¢ */
        #welcome-screen { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.5s; }
        #welcome-screen h1 { font-weight: 200; letter-spacing: 5px; font-size: 24px; margin-bottom: 30px; text-shadow: 0 0 10px rgba(0,255,170,0.5); }
        .key-input-box { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        #api-key-input { background: rgba(255,255,255,0.1); border: 1px solid #333; color: white; padding: 10px 15px; width: 300px; border-radius: 8px; text-align: center; outline: none; transition: 0.3s; }
        #api-key-input:focus { border-color: var(--accent-color); background: rgba(255,255,255,0.15); }
        #start-btn { padding: 10px 30px; border-radius: 20px; background: var(--accent-color); color: black; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        #start-btn:hover { box-shadow: 0 0 20px var(--accent-color); transform: scale(1.05); }
        .note { font-size: 10px; opacity: 0.4; margin-top: 20px; max-width: 300px; text-align: center; line-height: 1.5; }

        /* 2. ‰∏ªÁïåÈù¢ UI */
        nav { position: absolute; top: 0; width: 100%; padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; z-index: 10; opacity: 0.8; font-size: 12px; letter-spacing: 2px; }
        #status-bar { position: absolute; top: 80px; left: 50%; transform: translateX(-50%); display: flex; align-items: center; background: rgba(255,255,255,0.05); padding: 6px 16px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); z-index: 10; font-size: 12px; backdrop-filter: blur(5px); }
        .dot { width: 6px; height: 6px; background: #555; border-radius: 50%; margin-right: 8px; transition: 0.3s; }
        
        #chat-area { position: absolute; top: 180px; width: 100%; text-align: center; z-index: 20; padding: 0 20px; box-sizing: border-box; }
        #ai-reply { font-size: 18px; font-weight: 300; margin-bottom: 20px; min-height: 1.5em; text-shadow: 0 0 10px rgba(0,0,0,0.5); line-height: 1.6; max-width: 800px; margin-left: auto; margin-right: auto; }
        #user-speech { font-size: 14px; color: rgba(255,255,255,0.5); margin-bottom: 25px; font-style: italic; }
        
        #text-input { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1); border-radius: 25px; color: white; text-align: center; width: 260px; outline: none; font-size: 14px; padding: 10px 20px; transition: 0.3s; }
        #text-input:focus { border-color: var(--accent-color); background: rgba(0,0,0,0.5); width: 300px; }

        #controls { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; z-index: 20; }
        #mic-btn { width: 60px; height: 60px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; margin-bottom: 20px; font-size: 24px; backdrop-filter: blur(5px); }
        #mic-btn.active { border-color: #ff4444; box-shadow: 0 0 20px #ff4444; background: rgba(255,0,0,0.1); }
        
        #save-btn { padding: 10px 25px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.3); background: transparent; color: white; cursor: pointer; font-size: 11px; letter-spacing: 2px; transition: 0.3s; text-transform: uppercase; }
        #save-btn:hover { background: white; color: black; box-shadow: 0 0 15px white; }

        /* 3. Âç°ÁâáÂºπÁ™ó */
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(15px); }
        .card { width: 320px; padding: 40px; background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); border: 1px solid rgba(255,255,255,0.1); border-radius: 30px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative; }
        .card-date { font-size: 10px; opacity: 0.5; margin-bottom: 30px; letter-spacing: 4px; color: var(--accent-color); }
        .card-content { font-size: 16px; line-height: 1.8; font-weight: 300; margin-bottom: 40px; color: #eee; }
        .card-tag { display: inline-block; padding: 5px 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); font-size: 10px; color: var(--accent-color); }
        .close-card { position: absolute; top: 20px; right: 20px; cursor: pointer; opacity: 0.5; font-size: 20px; }
        
        /* ÈáçÊñ∞ËÆæÁΩÆ Key ÁöÑÂ∞èÊåâÈíÆ */
        #reset-key { position: fixed; top: 10px; left: 10px; opacity: 0.2; font-size: 10px; cursor: pointer; z-index: 2000; }
        #reset-key:hover { opacity: 1; }
    </style>
</head>
<body>

    <div id="welcome-screen">
        <h1>ENTER YEE'S SPACE</h1>
        <div class="key-input-box">
            <input type="text" id="api-key-input" placeholder="Paste your Google API Key here">
            <button id="start-btn">ENTER</button>
        </div>
        <p class="note">Key is saved locally in your browser.<br>It will not be uploaded to GitHub.</p>
    </div>

    <div id="reset-key" onclick="localStorage.removeItem('gemini_key'); location.reload();">RESET KEY</div>

    <nav>
        <div style="font-weight: bold;">YEE'S SPACE</div>
        <div style="opacity: 0.5;">MEMORY LINK</div>
    </nav>

    <div id="status-bar">
        <div class="dot" id="status-dot"></div> 
        <span id="status-text">Waiting for Key...</span>
    </div>

    <div id="chat-area">
        <div id="ai-reply">Waiting to start...</div>
        <div id="user-speech"></div>
        <input type="text" id="text-input" placeholder="Type or use microphone...">
    </div>

    <div id="controls">
        <div id="mic-btn">üéôÔ∏è</div>
        <button id="save-btn">GENERATE MEMORY CARD</button>
    </div>

    <div id="overlay">
        <div class="card">
            <div class="close-card" onclick="document.getElementById('overlay').style.display='none'">√ó</div>
            <div class="card-date" id="date-str">DATE</div>
            <div class="card-content" id="summary-text">Generating...</div>
            <div class="card-tag" id="summary-tag">#</div>
        </div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- Ê†∏ÂøÉÂèòÈáè ---
        let API_KEY = "";
        let conversationHistory = [];
        let analyser, dataArray, audioContext, particles;
        let isAudioReady = false;

        // --- 1. ÂêØÂä®ÈÄªËæë (Key ÁÆ°ÁêÜ) ---
        const welcomeScreen = document.getElementById('welcome-screen');
        const keyInput = document.getElementById('api-key-input');
        const startBtn = document.getElementById('start-btn');

        // Ê£ÄÊü•ÊòØÂê¶ÊúâÂ≠òËøáÁöÑ Key
        const savedKey = localStorage.getItem('gemini_key');
        if (savedKey) {
            API_KEY = savedKey;
            welcomeScreen.style.display = 'none'; // Áõ¥Êé•ËøõÂÖ•
            initAudioSystem();
        }

        startBtn.onclick = () => {
            const val = keyInput.value.trim();
            if (val.length > 10) {
                API_KEY = val;
                localStorage.setItem('gemini_key', val); // ‰øùÂ≠ò Key
                welcomeScreen.style.opacity = '0';
                setTimeout(() => welcomeScreen.style.display = 'none', 500);
                initAudioSystem();
            } else {
                alert("Please enter a valid API Key.");
            }
        };

        function updateStatus(text, color) {
            document.getElementById('status-text').innerText = text;
            const dot = document.getElementById('status-dot');
            dot.style.background = color;
            dot.style.boxShadow = `0 0 10px ${color}`;
        }

        // --- 2. Èü≥È¢ë‰∏éËßÜËßâÂàùÂßãÂåñ ---
        async function initAudioSystem() {
            document.getElementById('ai-reply').innerText = "Hello Yee. I am listening.";
            updateStatus("System Ready", "#00ffaa");

            // ÂàùÂßãÂåñ Three.js ËÉåÊôØ
            initVisuals();

            // Â∞ùËØïËé∑ÂèñÈ∫¶ÂÖãÈ£é
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                source.connect(analyser);
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                isAudioReady = true;
            } catch (e) {
                console.warn("Microphone access denied or not available.", e);
                updateStatus("Audio Disabled (Type Only)", "orange");
            }
        }

        // --- 3. Three.js Á≤íÂ≠êÁâπÊïà ---
        function initVisuals() {
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            camera.position.z = 10;

            // ‰ΩøÁî®Á®ãÂ∫èÁîüÊàêÁ≤íÂ≠êÔºàÊó†ÈúÄÂä†ËΩΩÂõæÁâáÔºåÈò≤Ê≠¢ÈªëÂ±èÔºâ
            const geometry = new THREE.BufferGeometry();
            const count = 1500;
            const pos = [];
            const cols = [];
            for(let i=0; i<count; i++) {
                pos.push((Math.random()-0.5)*15, (Math.random()-0.5)*15, (Math.random()-0.5)*10);
                cols.push(0, 1, Math.random()); // ÈùíËâ≤Á≥ª
            }
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(cols, 3));
            
            const material = new THREE.PointsMaterial({ size: 0.08, vertexColors: true, transparent: true, opacity: 0.8 });
            particles = new THREE.Points(geometry, material);
            scene.add(particles);

            function animate() {
                requestAnimationFrame(animate);
                let vol = 0;
                if(isAudioReady && analyser) {
                    analyser.getByteFrequencyData(dataArray);
                    vol = dataArray.reduce((a,b)=>a+b) / dataArray.length;
                }
                
                // Á≤íÂ≠êÊóãËΩ¨‰∏éÂëºÂê∏
                particles.rotation.y += 0.001;
                const scale = 1 + (vol / 255) * 0.3;
                particles.scale.set(scale, scale, scale);
                renderer.render(scene, camera);
            }
            animate();
        }

        // --- 4. Gemini API ‰∫§‰∫í (‰øÆÂ§ç‰∫ÜÊ®°ÂûãÂêçÁß∞) ---
        async function chatWithGemini(text) {
            if(!text) return;
            
            document.getElementById('user-speech').innerText = `‚Äú ${text} ‚Äù`;
            document.getElementById('ai-reply').innerText = "Thinking...";
            updateStatus("Connecting...", "cyan");

            conversationHistory.push({ role: "user", parts: [{ text: text }] });

            try {
                // *** ÂÖ≥ÈîÆ‰øÆÂ§çÔºö‰ΩøÁî® gemini-pro Ê®°ÂûãÔºåÂÖºÂÆπÊÄßÊõ¥Â•Ω ***
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${API_KEY}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: conversationHistory })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error?.message || "Server Error");
                }

                const reply = data.candidates[0].content.parts[0].text;
                document.getElementById('ai-reply').innerText = reply;
                conversationHistory.push({ role: "model", parts: [{ text: reply }] });
                updateStatus("Gemini Active", "#00ffaa");

            } catch (error) {
                console.error(error);
                document.getElementById('ai-reply').innerText = "Error: " + error.message;
                updateStatus("API Error", "red");
                if(error.message.includes("key") || error.message.includes("403")) {
                    alert("Invalid API Key. Please click 'RESET KEY' at top-left.");
                }
            }
        }

        // --- 5. ËæìÂÖ•‰∫§‰∫í ---
        const inputField = document.getElementById('text-input');
        inputField.addEventListener('keypress', (e) => {
            if(e.key === 'Enter') {
                chatWithGemini(e.target.value);
                e.target.value = '';
            }
        });

        // ËØ≠Èü≥ËØÜÂà´
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new Speech();
            recognition.lang = 'zh-CN'; // Êàñ 'en-US'
            recognition.interimResults = true;
            
            const micBtn = document.getElementById('mic-btn');
            micBtn.onclick = () => {
                try { recognition.start(); micBtn.classList.add('active'); } catch(e){}
            };

            recognition.onresult = (e) => {
                const transcript = Array.from(e.results).map(r=>r[0].transcript).join('');
                document.getElementById('user-speech').innerText = transcript;
                if(e.results[0].isFinal) {
                    micBtn.classList.remove('active');
                    chatWithGemini(transcript);
                }
            };
            recognition.onend = () => micBtn.classList.remove('active');
        } else {
            document.getElementById('mic-btn').style.display = 'none';
        }

        // --- 6. ÁîüÊàêÊÄªÁªìÂç°Áâá ---
        document.getElementById('save-btn').onclick = async () => {
            document.getElementById('overlay').style.display = 'flex';
            document.getElementById('date-str').innerText = new Date().toLocaleDateString().toUpperCase();
            
            if(conversationHistory.length === 0) {
                document.getElementById('summary-text').innerText = "No memories yet.";
                return;
            }

            try {
                const prompt = "Please summarize our conversation in a poetic way (within 30 words) and add a mood hashtag at the end.";
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        contents: [...conversationHistory, { role: "user", parts: [{ text: prompt }] }] 
                    })
                });
                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                const parts = text.split('#');
                document.getElementById('summary-text').innerText = parts[0];
                document.getElementById('summary-tag').innerText = parts[1] ? '#' + parts[1] : '#Memory';
            } catch(e) {
                document.getElementById('summary-text').innerText = "Failed to generate summary.";
            }
        };
    </script>
</body>
</html>
