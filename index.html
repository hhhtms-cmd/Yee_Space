<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yee's Space (Debug Version)</title>
    <style>
        :root { --main: #00ffaa; --bg: #000000; }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; overflow: hidden; }

        /* 1. ç™»å½•æ¡† (Key è¾“å…¥) */
        #login-box { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.3s; }
        .box-content { background: #111; padding: 40px; border-radius: 20px; border: 1px solid #333; text-align: center; width: 300px; }
        #key-input { width: 100%; padding: 10px; margin: 20px 0; background: #222; border: 1px solid #555; color: var(--main); text-align: center; border-radius: 5px; outline: none; }
        .btn-enter { background: var(--main); color: black; border: none; padding: 10px 30px; border-radius: 20px; font-weight: bold; cursor: pointer; }

        /* 2. ä¸»ç•Œé¢ */
        #top-bar { position: absolute; top: 10px; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box; z-index: 100; }
        .action-btn { background: rgba(255,255,255,0.1); border: 1px solid #444; color: white; padding: 5px 15px; border-radius: 15px; cursor: pointer; font-size: 12px; margin-left: 10px; }
        .reset-btn { background: rgba(255,0,0,0.2); border: 1px solid red; color: #ffaaaa; }
        
        #chat-container { position: absolute; top: 150px; width: 100%; text-align: center; z-index: 10; padding: 0 20px; box-sizing: border-box; }
        #ai-msg { font-size: 18px; line-height: 1.6; min-height: 40px; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
        #user-msg { font-size: 14px; opacity: 0.5; margin-top: 10px; font-style: italic; }

        #bottom-ctrl { position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%); text-align: center; z-index: 100; }
        #mic-circle { width: 60px; height: 60px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; margin-bottom: 15px; transition: 0.2s; }
        #mic-circle.active { border-color: var(--main); box-shadow: 0 0 20px var(--main); background: rgba(0,255,170,0.1); }

        /* 3. å¡ç‰‡å¼¹çª— */
        #card-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(10px); }
        .card-body { background: #1a1a1a; padding: 30px; border-radius: 20px; border: 1px solid #333; max-width: 300px; text-align: center; }
    </style>
</head>
<body>

    <div id="login-box">
        <div class="box-content">
            <h2 style="margin:0; font-weight:200;">YEE SPACE</h2>
            <p style="font-size:12px; color:#666;">è¯·è¾“å…¥æ–°çš„ Google API Key</p>
            <input type="password" id="key-input" placeholder="AIzaSy...">
            <button class="btn-enter" onclick="saveKey()">è¿›å…¥ç©ºé—´</button>
            <p style="font-size:10px; color:#444; margin-top:15px;">Key ä»…ä¿å­˜åœ¨ä½ çš„æµè§ˆå™¨æœ¬åœ°</p>
        </div>
    </div>

    <div id="top-bar">
        <div>
            <label class="action-btn">ğŸ“¸ ä¸Šä¼ ç…§ç‰‡ <input type="file" id="file-in" hidden accept="image/*"></label>
        </div>
        <div>
            <button class="action-btn reset-btn" onclick="resetKey()">ğŸ”„ æ›´æ¢ API KEY</button>
        </div>
    </div>

    <div id="chat-container">
        <div id="ai-msg">ç­‰å¾…é“¾æ¥...</div>
        <div id="user-msg"></div>
    </div>

    <div id="bottom-ctrl">
        <div id="mic-circle">ğŸ™ï¸</div>
        <button class="action-btn" id="gen-card">âœ¨ ç”Ÿæˆæ„Ÿæ‚Ÿå¡ç‰‡</button>
    </div>

    <div id="card-modal" onclick="this.style.display='none'">
        <div class="card-body">
            <div id="card-text">æ­£åœ¨ç”Ÿæˆ...</div>
        </div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- å…¨å±€å˜é‡ ---
        let API_KEY = localStorage.getItem('gemini_key_v2'); // ä½¿ç”¨ v2 é¿å…è¯»å–æ—§ç¼“å­˜
        let scene, camera, renderer, particles;
        let history = []; // å¯¹è¯è®°å½•

        // --- 1. å¯åŠ¨æ£€æŸ¥ ---
        if (API_KEY && API_KEY.startsWith("AIza")) {
            document.getElementById('login-box').style.display = 'none';
            initSpace();
        }

        window.saveKey = function() {
            const input = document.getElementById('key-input').value.trim();
            if (input.startsWith("AIza")) {
                localStorage.setItem('gemini_key_v2', input); // å­˜å…¥æ–° Key
                API_KEY = input;
                location.reload(); // åˆ·æ–°é¡µé¢ç”Ÿæ•ˆ
            } else {
                alert("Key æ ¼å¼çœ‹èµ·æ¥ä¸å¯¹ï¼Œåº”è¯¥æ˜¯ AIza å¼€å¤´");
            }
        };

        window.resetKey = function() {
            localStorage.removeItem('gemini_key_v2');
            location.reload(); // åˆ·æ–°åä¼šå¼¹å‡ºç™»å½•æ¡†
        };

        // --- 2. åˆå§‹åŒ– 3D åœºæ™¯ ---
        function initSpace() {
            document.getElementById('ai-msg').innerText = "ç³»ç»Ÿå°±ç»ªã€‚è¯·è¯´è¯æˆ–ä¸Šä¼ å›¾ç‰‡ã€‚";
            
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            camera.position.z = 15;

            // é»˜è®¤æ˜¾ç¤ºä¸€äº›éšæœºç²’å­
            createParticles(); 
            animate();
        }

        function createParticles(positions = null, colors = null) {
            if (particles) scene.remove(particles);
            
            const count = 1500;
            const geo = new THREE.BufferGeometry();
            const posArray = [];
            const colArray = [];

            if (positions) {
                geo.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
                geo.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            } else {
                for(let i=0; i<count; i++) {
                    posArray.push((Math.random()-0.5)*30, (Math.random()-0.5)*30, (Math.random()-0.5)*10);
                    colArray.push(0, 1, 0.8); // é»˜è®¤é’è‰²
                }
                geo.setAttribute('position', new THREE.Float32BufferAttribute(posArray, 3));
                geo.setAttribute('color', new THREE.Float32BufferAttribute(colArray, 3));
            }

            const mat = new THREE.PointsMaterial({ size: 0.1, vertexColors: true, transparent: true, opacity: 0.8 });
            particles = new THREE.Points(geo, mat);
            scene.add(particles);
        }

        function animate() {
            requestAnimationFrame(animate);
            if(particles) {
                particles.rotation.y += 0.001;
                // ç®€å•çš„æ³¢åŠ¨æ•ˆæœ
                const time = performance.now() * 0.001;
                particles.position.y = Math.sin(time) * 0.2;
            }
            renderer.render(scene, camera);
        }

        // --- 3. æ ¸å¿ƒï¼šä¸ Gemini å¯¹è¯ (å¸¦è¯¦ç»†æŠ¥é”™) ---
        async function chat(text) {
            document.getElementById('user-msg').innerText = text;
            document.getElementById('ai-msg').innerText = "Thinking...";
            history.push({ role: "user", parts: [{ text: text }] });

            try {
                // ä½¿ç”¨ gemini-1.5-flashï¼Œé€Ÿåº¦å¿«ï¼Œå…è´¹é¢åº¦é«˜
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: history })
                });

                const data = await response.json();

                if (!response.ok) {
                    // *** å…³é”®ï¼šæ•æ‰å…·ä½“çš„é”™è¯¯ä¿¡æ¯ ***
                    console.error("Gemini Error:", data);
                    const errCode = data.error?.code || response.status;
                    const errMsg = data.error?.message || "Unknown error";
                    
                    if (errCode === 400 && errMsg.includes("API key")) {
                        throw new Error("API Key æ— æ•ˆï¼è¯·ç‚¹å‡»å³ä¸Šè§’çº¢è‰²æŒ‰é’®æ›´æ¢ Keyã€‚");
                    } else if (errCode === 403) {
                         throw new Error("æƒé™ä¸è¶³ (403)ã€‚Key å¯èƒ½è¢«å°ï¼Œè¯·ç”³è¯·æ–° Keyã€‚");
                    } else {
                        throw new Error(`API é”™è¯¯ (${errCode}): ${errMsg}`);
                    }
                }

                const reply = data.candidates[0].content.parts[0].text;
                document.getElementById('ai-msg').innerText = reply;
                history.push({ role: "model", parts: [{ text: reply }] });

            } catch (e) {
                document.getElementById('ai-msg').innerHTML = `<span style="color:#ff5555; font-size:14px;">âŒ ${e.message}</span>`;
            }
        }

        // --- 4. è¯­éŸ³è¯†åˆ« ---
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (Speech) {
            const rec = new Speech();
            rec.lang = 'zh-CN';
            const micBtn = document.getElementById('mic-circle');
            
            micBtn.onclick = () => {
                try { rec.start(); micBtn.classList.add('active'); } catch(e){}
            };
            rec.onresult = (e) => {
                const t = e.results[0][0].transcript;
                chat(t);
            };
            rec.onend = () => micBtn.classList.remove('active');
        }

        // --- 5. å›¾ç‰‡è½¬ç²’å­ ---
        document.getElementById('file-in').onchange = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = new Image();
                img.onload = () => {
                    // åˆ›å»º canvas æå–åƒç´ 
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const size = 120; // ç²’å­å¯†åº¦
                    canvas.width = size; canvas.height = size;
                    ctx.drawImage(img, 0, 0, size, size);
                    const data = ctx.getImageData(0,0,size,size).data;
                    
                    const pos = [];
                    const cols = [];
                    for(let y=0; y<size; y++){
                        for(let x=0; x<size; x++){
                            const i = (y*size + x)*4;
                            if(data[i+3] > 100) { // å¦‚æœä¸æ˜¯é€æ˜çš„
                                pos.push((x-size/2)*0.1, -(y-size/2)*0.1, 0);
                                cols.push(data[i]/255, data[i+1]/255, data[i+2]/255);
                            }
                        }
                    }
                    createParticles(pos, cols);
                    document.getElementById('ai-msg').innerText = "è®°å¿†ç²’å­å·²åŠ è½½ã€‚";
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        };

        // --- 6. ç”Ÿæˆå¡ç‰‡ ---
        document.getElementById('gen-card').onclick = async () => {
            if(history.length === 0) return alert("è¿˜æ²¡æœ‰å¯¹è¯å“¦");
            document.getElementById('card-modal').style.display = 'flex';
            document.getElementById('card-text').innerText = "æ­£åœ¨ç”Ÿæˆå”¯ç¾æ€»ç»“...";
            
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        contents: [...history, { role: "user", parts: [{ text: "ç”¨ä¸€å¥è¯—æ„çš„è¯æ€»ç»“æˆ‘ä»¬çš„å¯¹è¯ï¼Œ30å­—ä»¥å†…ã€‚" }] }] 
                    })
                });
                const data = await res.json();
                document.getElementById('card-text').innerText = data.candidates[0].content.parts[0].text;
            } catch(e) {
                document.getElementById('card-text').innerText = "ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– Key";
            }
        };

        window.onresize = () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };

    </script>
</body>
</html>
