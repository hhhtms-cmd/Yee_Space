<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yee's Space (Stable)</title>
    <style>
        :root { --main: #00ffaa; --bg: #050505; }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; overflow: hidden; }

        /* ç™»å½•å±‚ */
        #login-box { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .box-content { background: #111; padding: 40px; border-radius: 20px; border: 1px solid #333; text-align: center; width: 300px; }
        #key-input { width: 100%; padding: 12px; margin: 20px 0; background: #222; border: 1px solid #555; color: var(--main); text-align: center; border-radius: 5px; outline: none; }
        .btn-enter { background: var(--main); color: black; border: none; padding: 10px 30px; border-radius: 20px; font-weight: bold; cursor: pointer; }

        /* ä¸»ç•Œé¢ */
        #top-bar { position: absolute; top: 15px; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box; z-index: 100; }
        .action-btn { background: rgba(255,255,255,0.1); border: 1px solid #444; color: white; padding: 6px 16px; border-radius: 20px; cursor: pointer; font-size: 12px; display: inline-block; }
        .reset-btn { border-color: #ff5555; color: #ffaaaa; }
        
        #chat-container { position: absolute; top: 160px; width: 100%; text-align: center; z-index: 10; padding: 0 20px; box-sizing: border-box; }
        #ai-msg { font-size: 19px; line-height: 1.6; min-height: 40px; text-shadow: 0 0 10px rgba(0,0,0,0.8); }
        #user-msg { font-size: 14px; opacity: 0.5; margin-top: 15px; font-style: italic; }

        #bottom-ctrl { position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%); text-align: center; z-index: 100; display: flex; flex-direction: column; align-items: center; }
        #mic-circle { width: 65px; height: 65px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; font-size: 28px; cursor: pointer; margin-bottom: 20px; transition: 0.3s; }
        #mic-circle.active { border-color: var(--main); box-shadow: 0 0 25px var(--main); background: rgba(0,255,170,0.1); transform: scale(1.1); }

        /* å¡ç‰‡å¼¹çª— */
        #card-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(10px); }
        .card-body { background: #1a1a1a; padding: 40px; border-radius: 20px; border: 1px solid #444; max-width: 320px; text-align: center; line-height: 1.8; }
    </style>
</head>
<body>

    <div id="login-box">
        <div class="box-content">
            <h2 style="margin:0; font-weight:200; letter-spacing: 2px;">YEE SPACE</h2>
            <p style="font-size:12px; color:#888;">è¯·è¾“å…¥æ‚¨çš„ Google API Key</p>
            <input type="password" id="key-input" placeholder="AIzaSy...">
            <button class="btn-enter" onclick="saveKey()">è¿›å…¥ç©ºé—´</button>
            <p style="font-size:10px; color:#555; margin-top:15px;">Key ä»…ä¿å­˜åœ¨æœ¬åœ°</p>
        </div>
    </div>

    <div id="top-bar">
        <label class="action-btn">ğŸ“¸ ä¸Šä¼ ç…§ç‰‡ç²’å­ <input type="file" id="file-in" hidden accept="image/*"></label>
        <button class="action-btn reset-btn" onclick="resetKey()">ğŸ”„ æ›´æ¢ API KEY</button>
    </div>

    <div id="chat-container">
        <div id="ai-msg">ç­‰å¾…è¿æ¥...</div>
        <div id="user-msg"></div>
    </div>

    <div id="bottom-ctrl">
        <div id="mic-circle">ğŸ™ï¸</div>
        <button class="action-btn" id="gen-card">âœ¨ ç”Ÿæˆä»Šæ—¥æ„Ÿæ‚Ÿ</button>
    </div>

    <div id="card-modal" onclick="this.style.display='none'">
        <div class="card-body">
            <div id="card-text">æ­£åœ¨å‡ç»“è®°å¿†...</div>
        </div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- æ ¸å¿ƒå˜é‡ ---
        let API_KEY = localStorage.getItem('yee_final_key'); 
        let scene, camera, renderer, particles;
        let history = []; 

        // --- 1. å¯åŠ¨é€»è¾‘ ---
        if (API_KEY && API_KEY.startsWith("AIza")) {
            document.getElementById('login-box').style.display = 'none';
            initSpace();
        }

        window.saveKey = function() {
            const input = document.getElementById('key-input').value.trim();
            if (input.startsWith("AIza")) {
                localStorage.setItem('yee_final_key', input);
                API_KEY = input;
                location.reload(); 
            } else {
                alert("Key æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ˜¯å¦å®Œæ•´å¤åˆ¶");
            }
        };

        window.resetKey = function() {
            if(confirm("ç¡®å®šè¦æ¸…é™¤ Key å¹¶é‡æ–°è¾“å…¥å—ï¼Ÿ")) {
                localStorage.removeItem('yee_final_key');
                location.reload();
            }
        };

        // --- 2. 3D ç²’å­åœºæ™¯ ---
        function initSpace() {
            document.getElementById('ai-msg').innerText = "æ˜Ÿé™…è¿çº¿æˆåŠŸã€‚è¯·ä¸Šä¼ ç…§ç‰‡æˆ–è¯´è¯ã€‚";
            
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            camera.position.z = 15;

            createParticles(); 
            animate();
        }

        function createParticles(positions = null, colors = null) {
            if (particles) scene.remove(particles);
            const geo = new THREE.BufferGeometry();
            
            if (positions) {
                // ç…§ç‰‡æ¨¡å¼
                geo.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
                geo.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            } else {
                // é»˜è®¤éšæœºæ¨¡å¼
                const pos = [], col = [];
                for(let i=0; i<1500; i++) {
                    pos.push((Math.random()-0.5)*30, (Math.random()-0.5)*30, (Math.random()-0.5)*10);
                    col.push(0, 1, 0.7); 
                }
                geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
                geo.setAttribute('color', new THREE.Float32BufferAttribute(col, 3));
            }

            particles = new THREE.Points(geo, new THREE.PointsMaterial({ size: 0.08, vertexColors: true, transparent: true, opacity: 0.8 }));
            scene.add(particles);
        }

        function animate() {
            requestAnimationFrame(animate);
            if(particles) {
                particles.rotation.y += 0.001; 
                particles.position.y = Math.sin(performance.now()*0.001)*0.2;
            }
            renderer.render(scene, camera);
        }

        // --- 3. æ ¸å¿ƒï¼šå¯¹è¯åŠŸèƒ½ (æ”¹å› gemini-pro) ---
        async function chat(text) {
            document.getElementById('user-msg').innerText = text;
            document.getElementById('ai-msg').innerText = "Thinking...";
            history.push({ role: "user", parts: [{ text: text }] });

            try {
                // *** ä¿®å¤ç‚¹ï¼šæ”¹å›æœ€ç¨³å®šçš„ gemini-pro ***
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${API_KEY}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: history })
                });

                const data = await response.json();

                if (!response.ok) {
                    console.error("API Error Details:", data);
                    const msg = data.error?.message || "æœªçŸ¥é”™è¯¯";
                    if(msg.includes("Key")) throw new Error("API Key æ— æ•ˆ");
                    throw new Error(msg);
                }

                const reply = data.candidates[0].content.parts[0].text;
                document.getElementById('ai-msg').innerText = reply;
                history.push({ role: "model", parts: [{ text: reply }] });

            } catch (e) {
                document.getElementById('ai-msg').innerHTML = `<span style="color:#ff5555">è¿æ¥æ–­å¼€: ${e.message}</span>`;
            }
        }

        // --- 4. åŠŸèƒ½ç»‘å®š ---
        // è¯­éŸ³
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (Speech) {
            const rec = new Speech();
            rec.lang = 'zh-CN';
            const btn = document.getElementById('mic-circle');
            btn.onclick = () => { try { rec.start(); btn.classList.add('active'); } catch(e){} };
            rec.onresult = (e) => { chat(e.results[0][0].transcript); };
            rec.onend = () => btn.classList.remove('active');
        }

        // ç…§ç‰‡
        document.getElementById('file-in').onchange = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = new Image();
                img.onload = () => {
                    const cvs = document.createElement('canvas');
                    const ctx = cvs.getContext('2d');
                    const size = 100; 
                    cvs.width = size; cvs.height = size;
                    ctx.drawImage(img, 0, 0, size, size);
                    const data = ctx.getImageData(0,0,size,size).data;
                    const p=[], c=[];
                    for(let y=0; y<size; y++){
                        for(let x=0; x<size; x++){
                            const i = (y*size+x)*4;
                            if(data[i+3]>100) {
                                p.push((x-size/2)*0.15, -(y-size/2)*0.15, 0);
                                c.push(data[i]/255, data[i+1]/255, data[i+2]/255);
                            }
                        }
                    }
                    createParticles(p, c);
                    document.getElementById('ai-msg').innerText = "å›¾ç‰‡å·²è½¬åŒ–ä¸ºè®°å¿†ç²’å­ã€‚";
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        };

        // æ€»ç»“
        document.getElementById('gen-card').onclick = async () => {
            if(history.length===0) return alert("è¯·å…ˆå¯¹è¯");
            document.getElementById('card-modal').style.display = 'flex';
            
            try {
                // æ€»ç»“ä¹Ÿä½¿ç”¨ gemini-pro
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [...history, { role: "user", parts: [{ text: "ç”¨å”¯ç¾çš„ä¸­æ–‡æ€»ç»“æˆ‘ä»¬çš„å¯¹è¯ï¼Œ30å­—ä»¥å†…" }] }] })
                });
                const data = await res.json();
                document.getElementById('card-text').innerText = data.candidates[0].content.parts[0].text;
            } catch(e) {
                document.getElementById('card-text').innerText = "ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ";
            }
        };

        window.onresize = () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };
    </script>
</body>
</html>
