<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yee's Space | Particle</title>
    <style>
        :root { --main: #00ffaa; --bg: #050505; }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; overflow: hidden; }

        /* é¡¶éƒ¨çŠ¶æ€ä¸å·¥å…· */
        #top-bar { position: absolute; top: 15px; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box; z-index: 100; }
        .action-btn { background: rgba(255,255,255,0.1); border: 1px solid #444; color: white; padding: 6px 16px; border-radius: 20px; cursor: pointer; font-size: 12px; backdrop-filter: blur(5px); }
        
        /* æ ¸å¿ƒå¯¹è¯åŒº */
        #chat-container { position: absolute; top: 120px; width: 100%; text-align: center; z-index: 10; padding: 0 20px; box-sizing: border-box; pointer-events: none; }
        #ai-msg { font-size: 20px; line-height: 1.6; min-height: 40px; text-shadow: 0 0 15px rgba(0,255,170,0.5); }
        #user-msg { font-size: 14px; opacity: 0.4; margin-top: 15px; font-style: italic; }
        #debug-tag { font-size: 10px; color: #333; margin-top: 10px; }

        /* åº•éƒ¨äº¤äº’ */
        #bottom-ctrl { position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); z-index: 100; text-align: center; }
        #mic-circle { width: 70px; height: 70px; border-radius: 50%; border: 1px solid rgba(0,255,170,0.3); background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; font-size: 30px; cursor: pointer; transition: 0.3s; }
        #mic-circle.active { border-color: var(--main); box-shadow: 0 0 30px var(--main); transform: scale(1.1); }

        /* ç™»å½•æ¡† */
        #login-box { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .box-content { background: #111; padding: 40px; border-radius: 20px; border: 1px solid #333; text-align: center; }
        input { width: 100%; padding: 12px; margin: 20px 0; background: #222; border: 1px solid #444; color: var(--main); text-align: center; border-radius: 5px; }
    </style>
</head>
<body>

    <div id="login-box">
        <div class="box-content">
            <h2 style="font-weight:200; letter-spacing:2px;">YEE SPACE</h2>
            <input type="password" id="key-input" placeholder="è¾“å…¥ API Key æ¿€æ´»ç©ºé—´">
            <button class="action-btn" style="background:var(--main); color:black; font-weight:bold;" onclick="saveKey()">å¼€å¯è¿çº¿</button>
        </div>
    </div>

    <div id="top-bar">
        <label class="action-btn">ğŸ“¸ ç²’å­åŒ–ç…§ç‰‡ <input type="file" id="file-in" hidden accept="image/*"></label>
        <button class="action-btn" onclick="resetKey()">ğŸ”„ é‡ç½®è¿æ¥</button>
    </div>

    <div id="chat-container">
        <div id="ai-msg">ç­‰å¾…æ˜Ÿé™…è¿æ¥...</div>
        <div id="user-msg"></div>
        <div id="debug-tag">Ready.</div>
    </div>

    <div id="bottom-ctrl">
        <div id="mic-circle">ğŸ™ï¸</div>
        <p style="font-size:10px; color:#444; margin-top:10px;">ç‚¹å‡»è¯´è¯</p>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        let API_KEY = localStorage.getItem('yee_final_particle_key');
        let scene, camera, renderer, particles;
        let history = [];

        // --- 1. åˆå§‹åŒ–ä¸ Key ç®¡ç† ---
        if (API_KEY) {
            document.getElementById('login-box').style.display = 'none';
            initSpace();
        }

        window.saveKey = () => {
            const val = document.getElementById('key-input').value.trim();
            if (val) { localStorage.setItem('yee_final_particle_key', val); location.reload(); }
        };

        window.resetKey = () => { localStorage.removeItem('yee_final_particle_key'); location.reload(); };

        // --- 2. 3D ç²’å­åœºæ™¯ ---
        function initSpace() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            camera.position.z = 15;

            createRandomParticles();
            animate();
            document.getElementById('ai-msg').innerText = "æ˜Ÿé™…é€šé“å·²åŠ å›ºã€‚è¯·å¼€å§‹äº¤è°ˆã€‚";
        }

        function createRandomParticles() {
            if (particles) scene.remove(particles);
            const geo = new THREE.BufferGeometry();
            const pos = [], cols = [];
            for (let i = 0; i < 2000; i++) {
                pos.push((Math.random() - 0.5) * 35, (Math.random() - 0.5) * 35, (Math.random() - 0.5) * 10);
                cols.push(0, 1, 0.66);
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            geo.setAttribute('color', new THREE.Float32BufferAttribute(cols, 3));
            const mat = new THREE.PointsMaterial({ size: 0.06, vertexColors: true, transparent: true, opacity: 0.6 });
            particles = new THREE.Points(geo, mat);
            scene.add(particles);
        }

        function animate() {
            requestAnimationFrame(animate);
            if (particles) {
                particles.rotation.y += 0.001;
                particles.rotation.x += 0.0005;
            }
            renderer.render(scene, camera);
        }

        // --- 3. ç…§ç‰‡è½¬åŒ–ä¸ºç²’å­ ---
        document.getElementById('file-in').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = new Image();
                img.onload = () => {
                    const cvs = document.createElement('canvas');
                    const ctx = cvs.getContext('2d');
                    const size = 100; 
                    cvs.width = size; cvs.height = size;
                    ctx.drawImage(img, 0, 0, size, size);
                    const data = ctx.getImageData(0,0,size,size).data;
                    const p = [], c = [];
                    for(let y=0; y<size; y++){
                        for(let x=0; x<size; x++){
                            const i = (y * size + x) * 4;
                            if(data[i+3] > 128) {
                                p.push((x - size/2) * 0.15, (size/2 - y) * 0.15, 0);
                                c.push(data[i]/255, data[i+1]/255, data[i+2]/255);
                            }
                        }
                    }
                    if (particles) scene.remove(particles);
                    const geo = new THREE.BufferGeometry();
                    geo.setAttribute('position', new THREE.Float32BufferAttribute(p, 3));
                    geo.setAttribute('color', new THREE.Float32BufferAttribute(c, 3));
                    particles = new THREE.Points(geo, new THREE.PointsMaterial({ size: 0.08, vertexColors: true }));
                    scene.add(particles);
                    document.getElementById('ai-msg').innerText = "è®°å¿†å·²è½¬åŒ–ä¸ºç²’å­ã€‚";
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        };

        // --- 4. ç¨³å®šç‰ˆå¯¹è¯é€»è¾‘ (v1 è·¯å¾„ + è‡ªåŠ¨åŒ¹é…) ---
        async function talkToAI(text) {
            document.getElementById('user-msg').innerText = text;
            document.getElementById('ai-msg').innerText = "ğŸŒŒ æ­£åœ¨åŒæ­¥ä¿¡å·...";
            history.push({ role: "user", parts: [{ text: text }] });

            // å°è¯•åˆ—è¡¨ï¼šv1 è·¯å¾„æ˜¯ç›®å‰æœ€ç¨³çš„
            const models = ["gemini-1.5-flash-latest", "gemini-1.5-flash"];
            let success = false;

            for (let modelName of models) {
                if (success) break;
                document.getElementById('debug-tag').innerText = `å°è¯•æ³¢æ®µ: ${modelName}`;
                
                try {
                    const url = `https://generativelanguage.googleapis.com/v1/models/${modelName}:generateContent?key=${API_KEY}`;
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: history })
                    });

                    const data = await res.json();
                    if (res.ok) {
                        const reply = data.candidates[0].content.parts[0].text;
                        document.getElementById('ai-msg').innerText = reply;
                        document.getElementById('debug-tag').innerText = `æˆåŠŸä½¿ç”¨: ${modelName}`;
                        history.push({ role: "model", parts: [{ text: reply }] });
                        success = true;
                    }
                } catch (e) {
                    console.error(e);
                }
            }

            if (!success) {
                document.getElementById('ai-msg').innerText = "âš ï¸ æ‰€æœ‰æ³¢æ®µå‡ 404ï¼Œè¯·ç¡®è®¤ API Key æƒé™ã€‚";
            }
        }

        // --- 5. è¯­éŸ³è¯†åˆ« ---
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (Speech) {
            const rec = new Speech();
            rec.lang = 'zh-CN';
            const btn = document.getElementById('mic-circle');
            btn.onclick = () => { try { rec.start(); btn.classList.add('active'); } catch(e){} };
            rec.onresult = (e) => talkToAI(e.results[0][0].transcript);
            rec.onend = () => btn.classList.remove('active');
        }

        window.onresize = () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };
    </script>
</body>
</html>
