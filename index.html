<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yee's Space V3</title>
    <style>
        :root { --main: #00ffaa; --bg: #050505; }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; overflow: hidden; }
        #login-box { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .box-content { background: #111; padding: 40px; border-radius: 20px; border: 1px solid #333; text-align: center; width: 300px; }
        #key-input { width: 100%; padding: 12px; margin: 20px 0; background: #222; border: 1px solid #555; color: var(--main); text-align: center; border-radius: 5px; outline: none; }
        .btn-enter { background: var(--main); color: black; border: none; padding: 10px 30px; border-radius: 20px; font-weight: bold; cursor: pointer; }
        #top-bar { position: absolute; top: 15px; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box; z-index: 100; }
        .action-btn { background: rgba(255,255,255,0.1); border: 1px solid #444; color: white; padding: 6px 16px; border-radius: 20px; cursor: pointer; font-size: 12px; }
        #chat-container { position: absolute; top: 160px; width: 100%; text-align: center; z-index: 10; padding: 0 20px; box-sizing: border-box; }
        #ai-msg { font-size: 19px; line-height: 1.6; min-height: 40px; text-shadow: 0 0 10px rgba(0,0,0,0.8); }
        #status { font-size: 10px; color: #444; margin-top: 10px; }
        #mic-circle { position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%); width: 70px; height: 70px; border-radius: 50%; border: 1px solid #333; background: #111; display: flex; align-items: center; justify-content: center; font-size: 30px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="login-box">
        <div class="box-content">
            <h2 style="letter-spacing:2px;">YEE SPACE V3</h2>
            <p style="font-size:12px; color:#888;">è¯·è¾“å…¥æ‚¨çš„ Google API Key</p>
            <input type="password" id="key-input" placeholder="AIzaSy...">
            <button class="btn-enter" onclick="saveKey()">æ¿€æ´»ç©ºé—´</button>
        </div>
    </div>

    <div id="top-bar">
        <label class="action-btn">ğŸ“¸ ä¸Šä¼ ç…§ç‰‡ <input type="file" id="file-in" hidden accept="image/*"></label>
        <button class="action-btn" onclick="resetKey()">ğŸ”„ æ›´æ¢ KEY</button>
    </div>

    <div id="chat-container">
        <div id="ai-msg">å‡†å¤‡å°±ç»ªã€‚è¯·è¯´è¯ã€‚</div>
        <div id="status">Status: Ready</div>
        <div id="user-msg" style="font-size:14px; opacity:0.5; margin-top:20px;"></div>
    </div>

    <div id="mic-circle" id="mic-btn">ğŸ™ï¸</div>

    <script type="importmap"> { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } } </script>

    <script type="module">
        import * as THREE from 'three';

        // ä½¿ç”¨ V3 å­˜å‚¨é”®åï¼Œå¼ºåˆ¶ç”¨æˆ·é‡æ–°è¾“å…¥ä¸€æ¬¡ Keyï¼Œæ’é™¤æ—§å¹²æ‰°
        let API_KEY = localStorage.getItem('yee_v3_key'); 
        let history = [];

        if (API_KEY) { 
            document.getElementById('login-box').style.display = 'none'; 
            initVisuals(); 
        }

        window.saveKey = () => {
            const val = document.getElementById('key-input').value.trim();
            if (val) { localStorage.setItem('yee_v3_key', val); location.reload(); }
        };

        window.resetKey = () => { localStorage.removeItem('yee_v3_key'); location.reload(); };

        function initVisuals() {
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            camera.position.z = 15;
            const geo = new THREE.BufferGeometry();
            const pos = [];
            for(let i=0; i<800; i++) pos.push((Math.random()-0.5)*30, (Math.random()-0.5)*30, (Math.random()-0.5)*10);
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            const points = new THREE.Points(geo, new THREE.PointsMaterial({ size: 0.05, color: 0x00ffaa }));
            scene.add(points);
            function anim() { requestAnimationFrame(anim); points.rotation.y += 0.002; renderer.render(scene, camera); }
            anim();
        }

        async function talkToGemini(text) {
            document.getElementById('user-msg').innerText = "â€œ" + text + "â€";
            document.getElementById('ai-msg').innerText = "æ­£åœ¨åŒæ­¥æ˜Ÿé™…ä¿¡å·...";
            document.getElementById('status').innerText = "Connecting...";

            history.push({ role: "user", parts: [{ text: text }] });

            try {
                // ä½¿ç”¨å®˜æ–¹æ¨èçš„ v1 ç‰ˆæœ¬ï¼Œç›´æ¥è°ƒç”¨ 1.5-flash
                const url = `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: history })
                });

                const data = await response.json();

                if (!response.ok) {
                    // æ ¸å¿ƒè°ƒè¯•ï¼šç›´æ¥æ˜¾ç¤ºæœåŠ¡å™¨è¿”å›çš„åŸå§‹é”™è¯¯
                    const errorDetail = data.error ? data.error.message : "Network Error";
                    throw new Error(errorDetail);
                }

                const reply = data.candidates[0].content.parts[0].text;
                document.getElementById('ai-msg').innerText = reply;
                document.getElementById('status').innerText = "Status: Received";
                history.push({ role: "model", parts: [{ text: reply }] });

            } catch (e) {
                console.error(e);
                document.getElementById('ai-msg').innerText = "âš ï¸ ä¿¡å·ä¸­æ–­";
                document.getElementById('status').innerText = "é”™è¯¯è¯¦æƒ…: " + e.message;
                // å¦‚æœæ˜¯ Key é”™è¯¯ï¼Œçº¢è‰²åŠ äº®æç¤º
                if(e.message.includes("key")) {
                    document.getElementById('status').style.color = "red";
                }
            }
        }

        // è¯­éŸ³æ§åˆ¶
        const mic = document.getElementById('mic-circle');
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'zh-CN';

        mic.onclick = () => {
            try { recognition.start(); document.getElementById('status').innerText = "Status: Listening..."; } catch(e){}
        };

        recognition.onresult = (e) => {
            const transcript = e.results[0][0].transcript;
            talkToGemini(transcript);
        };
    </script>
</body>
</html>
