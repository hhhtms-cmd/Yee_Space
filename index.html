<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yee Space Final Fix</title>
    <style>
        body { margin: 0; background: #050505; color: #00ffaa; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        #display { width: 85%; text-align: center; font-size: 18px; line-height: 1.6; min-height: 100px; text-shadow: 0 0 10px rgba(0,255,170,0.3); }
        #mic-btn { width: 80px; height: 80px; border-radius: 50%; border: 1px solid #00ffaa; font-size: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; margin-top: 30px; }
        #mic-btn.active { box-shadow: 0 0 30px #00ffaa; background: rgba(0,255,170,0.1); }
        #error-info { position: fixed; bottom: 20px; color: #ff4444; font-size: 11px; width: 90%; text-align: center; background: rgba(0,0,0,0.8); padding: 5px; border-radius: 5px; display: none; }
        .reset-btn { position: fixed; top: 20px; right: 20px; background: none; border: 1px solid #333; color: #555; padding: 5px 10px; border-radius: 10px; cursor: pointer; font-size: 10px; }
    </style>
</head>
<body>

    <button class="reset-btn" onclick="resetKey()">RESET KEY</button>

    <div id="display">æ­£åœ¨å»ºç«‹æ˜Ÿé™…è¿æ¥...</div>
    
    <div id="mic-btn">ğŸ™ï¸</div>
    
    <div id="error-info"></div>

    <script>
        let API_KEY = localStorage.getItem('yee_final_fix_key');

        if (!API_KEY) {
            API_KEY = prompt("æ£€æµ‹åˆ° 404 é”™è¯¯å·²å®šä½ï¼Œè¯·è¾“å…¥ API Key é‡æ–°æ¿€æ´»ï¼š");
            if (API_KEY) {
                localStorage.setItem('yee_final_fix_key', API_KEY);
                location.reload();
            }
        }

        const display = document.getElementById('display');
        const errInfo = document.getElementById('error-info');
        if(API_KEY) display.innerText = "è¿æ¥å·²å»ºç«‹ã€‚è¯·æŒ‰ä½éº¦å…‹é£è¯´è¯ã€‚";

        function resetKey() {
            localStorage.removeItem('yee_final_fix_key');
            location.reload();
        }

        async function callGemini(text) {
            display.innerText = "ğŸŒŒ æ­£åœ¨ç©¿è¶Šæ˜Ÿäº‘...";
            errInfo.style.display = "none";

            // ä¿®å¤å…³é”®ï¼šå°è¯• v1beta è·¯å¾„ + å®Œæ•´æ¨¡å‹è·¯å¾„
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: text }] }]
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error?.message || "è¯·æ±‚å¤±è´¥");
                }

                if (data.candidates && data.candidates[0].content) {
                    display.innerText = data.candidates[0].content.parts[0].text;
                }
            } catch (err) {
                console.error(err);
                display.innerText = "âš ï¸ ä¼ è¾“ä¸­æ–­";
                errInfo.style.display = "block";
                errInfo.innerText = "è¯Šæ–­åé¦ˆ: " + err.message;
            }
        }

        // è¯­éŸ³é€»è¾‘
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            const btn = document.getElementById('mic-btn');

            btn.onclick = () => {
                recognition.start();
                btn.classList.add('active');
                display.innerText = "æ­£åœ¨å€¾å¬...";
            };

            recognition.onresult = (e) => {
                callGemini(e.results[0][0].transcript);
            };

            recognition.onend = () => {
                btn.classList.remove('active');
            };
        } else {
            display.innerText = "è¯·ä½¿ç”¨ Chrome æµè§ˆå™¨ä»¥å¼€å¯è¯­éŸ³åŠŸèƒ½";
        }
    </script>
</body>
</html>
