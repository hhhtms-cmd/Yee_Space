<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yee's Memory Space</title>
    <style>
        :root { --accent-color: #00ffaa; --bg-color: #050505; }
        body { margin: 0; background: var(--bg-color); overflow: hidden; color: white; font-family: "PingFang SC", "Helvetica Neue", sans-serif; }
        
        /* ç¬¬ä¸€æ¬¡è¿›å…¥æ—¶çš„ Key è¾“å…¥æ¡† */
        #auth-overlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .auth-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 40px; border-radius: 30px; text-align: center; backdrop-filter: blur(10px); }
        #key-input { background: rgba(255,255,255,0.1); border: 1px solid #333; color: var(--accent-color); padding: 12px; width: 300px; border-radius: 10px; text-align: center; margin: 20px 0; outline: none; }
        .start-btn { background: var(--accent-color); color: black; border: none; padding: 10px 40px; border-radius: 20px; font-weight: bold; cursor: pointer; }

        /* é¡¶éƒ¨ä¸Šä¼ åŒºåŸŸ */
        #top-ui { position: absolute; top: 20px; width: 100%; display: flex; justify-content: center; z-index: 100; }
        .upload-label { background: rgba(255,255,255,0.08); border: 1px dashed rgba(255,255,255,0.3); padding: 8px 25px; border-radius: 20px; cursor: pointer; font-size: 12px; letter-spacing: 1px; transition: 0.3s; }
        .upload-label:hover { border-color: var(--accent-color); background: rgba(0,255,170,0.1); }
        #file-input { display: none; }

        /* èŠå¤©æ˜¾ç¤ºåŒºåŸŸ */
        #display-area { position: absolute; top: 180px; width: 100%; text-align: center; padding: 0 20px; box-sizing: border-box; }
        #ai-text { font-size: 20px; font-weight: 300; line-height: 1.6; margin-bottom: 20px; min-height: 1.5em; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
        #user-text { font-size: 14px; color: rgba(255,255,255,0.4); font-style: italic; }

        /* åº•éƒ¨æ§åˆ¶æ  */
        #footer { position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; z-index: 100; }
        #mic-btn { width: 70px; height: 70px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 28px; transition: 0.3s; margin-bottom: 20px; }
        #mic-btn.active { border-color: #ff4444; box-shadow: 0 0 30px #ff4444; background: rgba(255,0,0,0.1); }
        #save-btn { background: none; border: 1px solid rgba(255,255,255,0.2); color: white; padding: 8px 20px; border-radius: 15px; font-size: 11px; cursor: pointer; opacity: 0.6; }
        #save-btn:hover { opacity: 1; border-color: white; }

        /* æ€»ç»“å¡ç‰‡ */
        #card-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 10000; backdrop-filter: blur(20px); }
        .card-body { width: 300px; padding: 40px; border: 1px solid rgba(255,255,255,0.1); border-radius: 30px; background: rgba(255,255,255,0.02); text-align: center; }
        
        /* éšè—çš„é‡ç½®æŒ‰é’®ï¼ˆå·¦ä¸‹è§’ï¼Œé˜²å¤‡ä¸‡ä¸€éœ€è¦æ¢Keyï¼‰ */
        #reset-link { position: fixed; bottom: 10px; left: 10px; font-size: 9px; opacity: 0.1; cursor: pointer; }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="auth-card">
            <h2 style="font-weight: 200; letter-spacing: 5px;">YEE'S MEMORY</h2>
            <p style="font-size: 12px; opacity: 0.6;">è¯·è¾“å…¥æ‚¨çš„ Google API Key</p>
            <input type="password" id="key-input" placeholder="AIzaSy...">
            <br>
            <button class="start-btn" onclick="handleAuth()">å¼€å¯ç©ºé—´</button>
        </div>
    </div>

    <div id="reset-link" onclick="localStorage.removeItem('yee_key'); location.reload();">RESET KEY</div>

    <div id="top-ui">
        <label for="file-input" class="upload-label">ğŸ“¸ ä¸Šä¼ ç…§ç‰‡è½¬åŒ–è®°å¿†ç²’å­</label>
        <input type="file" id="file-input" accept="image/*">
    </div>

    <div id="display-area">
        <div id="ai-text">æ¬¢è¿å›æ¥ã€‚</div>
        <div id="user-text"></div>
    </div>

    <div id="footer">
        <div id="mic-btn">ğŸ™ï¸</div>
        <button id="save-btn">ç”Ÿæˆè®°å¿†å¡ç‰‡</button>
    </div>

    <div id="card-overlay" onclick="this.style.display='none'">
        <div class="card-body">
            <p id="card-text" style="line-height: 1.8;"></p>
        </div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        let API_KEY = localStorage.getItem('yee_key') || "";
        let scene, camera, renderer, particles, geometry;
        let audioContext, analyser, dataArray, isAudioReady = false;
        let history = [];

        // éªŒè¯è¿›å…¥
        if (API_KEY) {
            document.getElementById('auth-overlay').style.display = 'none';
            initAll();
        }

        window.handleAuth = function() {
            const key = document.getElementById('key-input').value.trim();
            if (key.startsWith("AIza")) {
                localStorage.setItem('yee_key', key);
                API_KEY = key;
                document.getElementById('auth-overlay').style.display = 'none';
                initAll();
            } else {
                alert("Key æ ¼å¼ä¸æ­£ç¡®");
            }
        };

        function initAll() {
            initThree();
            initAudio();
        }

        // è§†è§‰èƒŒæ™¯
        function initThree() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            camera.position.z = 15;
            
            // åˆå§‹éšæœºç²’å­
            createRandomParticles();
            animate();
        }

        function createRandomParticles() {
            if(particles) scene.remove(particles);
            const count = 1500;
            const pos = [], cols = [];
            for(let i=0; i<count; i++) {
                pos.push((Math.random()-0.5)*30, (Math.random()-0.5)*30, (Math.random()-0.5)*10);
                cols.push(0, 1, 0.7);
            }
            geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(cols, 3));
            particles = new THREE.Points(geometry, new THREE.PointsMaterial({ size: 0.08, vertexColors: true, transparent: true, opacity: 0.6 }));
            scene.add(particles);
        }

        // å›¾ç‰‡è½¬ç²’å­é€»è¾‘
        document.getElementById('file-input').onchange = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const size = 100;
                    canvas.width = size; canvas.height = size;
                    ctx.drawImage(img, 0, 0, size, size);
                    const data = ctx.getImageData(0, 0, size, size).data;
                    const pos = [], cols = [];
                    for(let y=0; y<size; y++) {
                        for(let x=0; x<size; x++) {
                            const i = (y * size + x) * 4;
                            if(data[i+3] > 128) {
                                pos.push((x - size/2) * 0.15, -(y - size/2) * 0.15, 0);
                                cols.push(data[i]/255, data[i+1]/255, data[i+2]/255);
                            }
                        }
                    }
                    if(particles) scene.remove(particles);
                    geometry = new THREE.BufferGeometry();
                    geometry.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
                    geometry.setAttribute('color', new THREE.Float32BufferAttribute(cols, 3));
                    particles = new THREE.Points(geometry, new THREE.PointsMaterial({ size: 0.08, vertexColors: true, transparent: true }));
                    scene.add(particles);
                    document.getElementById('ai-text').innerText = "ç…§ç‰‡è®°å¿†å·²åŠ è½½å…¥åœºã€‚";
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        };

        function animate() {
            requestAnimationFrame(animate);
            let v = 0;
            if(isAudioReady && analyser) {
                analyser.getByteFrequencyData(dataArray);
                v = dataArray.reduce((a, b) => a + b) / dataArray.length;
            }
            if(particles) {
                particles.rotation.y += 0.001;
                const attr = geometry.attributes.position;
                for(let i=0; i<attr.array.length; i+=3) {
                    attr.array[i+2] = Math.sin(performance.now()*0.002 + attr.array[i]) * (0.2 + v*0.05);
                }
                attr.needsUpdate = true;
            }
            renderer.render(scene, camera);
        }

        async function initAudio() {
            try {
                const s = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(s);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                source.connect(analyser);
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                isAudioReady = true;
            } catch(e) { console.warn("Mic error"); }
        }

        // èŠå¤©é€»è¾‘
        async function talk(text) {
            if(!text) return;
            history.push({ role: "user", parts: [{ text: text }] });
            document.getElementById('ai-text').innerText = "æ­£åœ¨å€¾å¬æ˜Ÿé™…å›å“...";
            
            try {
                // ä½¿ç”¨æœ€ç¨³å®šçš„ gemini-pro
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: history })
                });
                const data = await res.json();
                const reply = data.candidates[0].content.parts[0].text;
                document.getElementById('ai-text').innerText = reply;
                history.push({ role: "model", parts: [{ text: reply }] });
            } catch (e) {
                document.getElementById('ai-text').innerText = "è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Key æ˜¯å¦æœ‰æ•ˆå¹¶åˆ·æ–°ã€‚";
            }
        }

        // è¯­éŸ³è¯†åˆ«
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(Speech) {
            const rec = new Speech();
            rec.lang = 'zh-CN';
            document.getElementById('mic-btn').onclick = () => { rec.start(); document.getElementById('mic-btn').classList.add('active'); };
            rec.onresult = (e) => {
                const t = e.results[0][0].transcript;
                document.getElementById('user-text').innerText = t;
                talk(t);
            };
            rec.onend = () => document.getElementById('mic-btn').classList.remove('active');
        }

        // ç”Ÿæˆå¡ç‰‡
        document.getElementById('save-btn').onclick = async () => {
            if(history.length === 0) return alert("è¿˜æ²¡æœ‰å¯¹è¯");
            document.getElementById('card-overlay').style.display = 'flex';
            document.getElementById('card-text').innerText = "è®°å¿†å‡ç»“ä¸­...";
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [...history, { role:"user", parts:[{text:"ç”¨30å­—ä»¥å†…æ€»ç»“è¿™æ®µå¯¹è¯ï¼Œå†™å¾—åƒæ—¥è®°ä¸€æ ·å”¯ç¾ã€‚"}]}] })
                });
                const data = await res.json();
                document.getElementById('card-text').innerText = data.candidates[0].content.parts[0].text;
            } catch(e) { document.getElementById('card-text').innerText = "æ„Ÿæ‚Ÿå¤±è´¥"; }
        };

        window.onresize = () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };
    </script>
</body>
</html>
