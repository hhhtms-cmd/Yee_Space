<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yee's Space (Auto-Logic)</title>
    <style>
        :root { --main: #00ffaa; --bg: #050505; }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; overflow: hidden; }

        /* ç™»å½•å±‚ */
        #login-box { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .box-content { background: #111; padding: 40px; border-radius: 20px; border: 1px solid #333; text-align: center; width: 300px; }
        #key-input { width: 100%; padding: 12px; margin: 20px 0; background: #222; border: 1px solid #555; color: var(--main); text-align: center; border-radius: 5px; outline: none; }
        .btn-enter { background: var(--main); color: black; border: none; padding: 10px 30px; border-radius: 20px; font-weight: bold; cursor: pointer; }

        /* ä¸»ç•Œé¢ */
        #top-bar { position: absolute; top: 15px; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box; z-index: 100; }
        .action-btn { background: rgba(255,255,255,0.1); border: 1px solid #444; color: white; padding: 6px 16px; border-radius: 20px; cursor: pointer; font-size: 12px; display: inline-block; }
        .reset-btn { border-color: #ff5555; color: #ffaaaa; }
        
        #chat-container { position: absolute; top: 160px; width: 100%; text-align: center; z-index: 10; padding: 0 20px; box-sizing: border-box; }
        #ai-msg { font-size: 19px; line-height: 1.6; min-height: 40px; text-shadow: 0 0 10px rgba(0,0,0,0.8); }
        #model-tag { font-size: 10px; color: #555; margin-top: 5px; border: 1px solid #333; padding: 2px 8px; border-radius: 10px; display: inline-block; }

        #bottom-ctrl { position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%); text-align: center; z-index: 100; display: flex; flex-direction: column; align-items: center; }
        #mic-circle { width: 65px; height: 65px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; font-size: 28px; cursor: pointer; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div id="login-box">
        <div class="box-content">
            <h2 style="margin:0; font-weight:200;">YEE SPACE</h2>
            <p style="font-size:12px; color:#888;">è¯·è¾“å…¥æ‚¨çš„ Google API Key</p>
            <input type="password" id="key-input" placeholder="AIzaSy...">
            <button class="btn-enter" onclick="saveKey()">æ¿€æ´»ç©ºé—´</button>
        </div>
    </div>

    <div id="top-bar">
        <label class="action-btn">ğŸ“¸ ä¸Šä¼ ç…§ç‰‡ <input type="file" id="file-in" hidden accept="image/*"></label>
        <button class="action-btn reset-btn" onclick="resetKey()">ğŸ”„ æ›´æ¢ KEY</button>
    </div>

    <div id="chat-container">
        <div id="ai-msg">æ­£åœ¨å¯»æ‰¾å¯ç”¨çš„æ˜Ÿé™…æ³¢æ®µ...</div>
        <div id="model-tag">ä¾¦æµ‹ä¸­...</div>
        <div id="user-msg" style="font-size:14px; opacity:0.5; margin-top:10px;"></div>
    </div>

    <div id="bottom-ctrl">
        <div id="mic-circle">ğŸ™ï¸</div>
    </div>

    <script type="importmap"> { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } } </script>

    <script type="module">
        import * as THREE from 'three';

        let API_KEY = localStorage.getItem('yee_fix_key'); 
        let ACTIVE_MODEL_PATH = ""; // è‡ªåŠ¨è·å–çš„è·¯å¾„
        let scene, camera, renderer, particles, history = [];

        if (API_KEY) { document.getElementById('login-box').style.display = 'none'; init(); }

        window.saveKey = () => {
            const input = document.getElementById('key-input').value.trim();
            if (input) { localStorage.setItem('yee_fix_key', input); location.reload(); }
        };

        window.resetKey = () => { localStorage.removeItem('yee_fix_key'); location.reload(); };

        // --- æ ¸å¿ƒï¼šè‡ªåŠ¨å¯»æ‰¾èƒ½ç”¨çš„æ¨¡å‹ ---
        async function detectModel() {
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${API_KEY}`);
                const data = await res.json();
                
                // ç­›é€‰å‡ºæ”¯æŒç”Ÿæˆå†…å®¹çš„æ‰€æœ‰æ¨¡å‹
                const models = data.models.filter(m => m.supportedGenerationMethods.includes("generateContent"));
                
                // ä¼˜å…ˆçº§æ’åºï¼š1.5-flash > 1.5-pro > 1.0-pro
                let target = models.find(m => m.name.includes("1.5-flash")) || 
                             models.find(m => m.name.includes("gemini-pro")) || 
                             models[0];

                if (target) {
                    ACTIVE_MODEL_PATH = target.name; // æ¯”å¦‚ "models/gemini-1.5-flash"
                    document.getElementById('model-tag').innerText = "å·²é€‚é…: " + target.displayName;
                    document.getElementById('ai-msg').innerText = "æ˜Ÿé™…è¿çº¿æˆåŠŸã€‚";
                } else {
                    throw new Error("æ— å¯ç”¨æ¨¡å‹");
                }
            } catch (e) {
                document.getElementById('ai-msg').innerText = "ä¾¦æµ‹å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Key æ˜¯å¦æœ‰æ•ˆã€‚";
                console.error(e);
            }
        }

        async function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            camera.position.z = 15;
            
            // ç²’å­ç³»ç»Ÿ
            const geo = new THREE.BufferGeometry();
            const pos = [];
            for(let i=0; i<1000; i++) pos.push((Math.random()-0.5)*30, (Math.random()-0.5)*30, (Math.random()-0.5)*10);
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            particles = new THREE.Points(geo, new THREE.PointsMaterial({ size: 0.05, color: 0x00ffaa }));
            scene.add(particles);

            function animate() {
                requestAnimationFrame(animate);
                particles.rotation.y += 0.001;
                renderer.render(scene, camera);
            }
            animate();

            // å¼€å§‹è‡ªåŠ¨ä¾¦æµ‹æ¨¡å‹
            await detectModel();
        }

        async function chat(text) {
            if (!ACTIVE_MODEL_PATH) return;
            document.getElementById('user-msg').innerText = text;
            document.getElementById('ai-msg').innerText = "æ€è€ƒä¸­...";
            history.push({ role: "user", parts: [{ text: text }] });

            try {
                // åŠ¨æ€ä½¿ç”¨ä¾¦æµ‹åˆ°çš„è·¯å¾„
                const url = `https://generativelanguage.googleapis.com/v1beta/${ACTIVE_MODEL_PATH}:generateContent?key=${API_KEY}`;
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: history })
                });
                const data = await res.json();
                const reply = data.candidates[0].content.parts[0].text;
                document.getElementById('ai-msg').innerText = reply;
                history.push({ role: "model", parts: [{ text: reply }] });
            } catch (e) {
                document.getElementById('ai-msg').innerText = "å‘é€å¤±è´¥ã€‚";
            }
        }

        // è¯­éŸ³ç»‘å®š
        const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        rec.lang = 'zh-CN';
        document.getElementById('mic-circle').onclick = () => rec.start();
        rec.onresult = (e) => chat(e.results[0][0].transcript);
    </script>
</body>
</html>
